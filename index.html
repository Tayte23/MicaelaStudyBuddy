<script>
window.addEventListener("DOMContentLoaded", () => {

  /* ================== Small safety helper ================== */
  function on(el, event, handler){
    if(!el) return false;
    el.addEventListener(event, handler);
    return true;
  }

  /* ====== REWARD SETTINGS ====== */
  const REWARD = { verified: 1.25, confidentBonus: 0.25 };

  /* ====== Confidence Options ====== */
  const CONF_OPTIONS = [
    { value: "not", label: "üòü Not confident" },
    { value: "some", label: "üôÇ Getting there" },
    { value: "yes", label: "üòÑ Very confident" }
  ];

  /* ====== DATA (Maths + English) ======
     ‚úÖ FIX: DO NOT self-reference DATA.
     Choose ONE of these options:

     OPTION A (recommended): If your big DATA object is in this same script:
       const DATA = { maths:[...], english:[...] };

     OPTION B: If your big DATA object is defined as window.DATA somewhere else:
       const DATA = window.DATA;

     Below is OPTION B as a safe fallback, but it will still fail if window.DATA is missing.
  */
  const DATA = window.DATA; // <-- only use this if you defined window.DATA earlier

  if(!DATA || !DATA.maths || !DATA.english){
    console.error("DATA missing. Make sure DATA is defined before this script runs.");
    // Show a helpful message instead of a blank page:
    document.body.innerHTML = `
      <div style="font-family:system-ui;padding:24px;">
        <h2>‚ö†Ô∏è DATA is missing</h2>
        <p>Your app loaded, but the <b>DATA</b> object was not found.</p>
        <p>Fix: ensure your big <code>const DATA = {...}</code> is in the script, OR set <code>window.DATA = {...}</code> before this runs.</p>
      </div>
    `;
    return;
  }

  /* ====== Storage ====== */
  const STORAGE_KEY = "micaela_ks2_checklist_v2_verified";

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {};
      return JSON.parse(raw);
    }catch(e){
      return {};
    }
  }
  function saveState(nextState){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(nextState));
  }

  let state = loadState();

  function getTopicState(id){
    return state[id] || { conf:"some", practice:false, quizOk:false, explainOk:false };
  }
  function setTopicState(id, patch){
    state[id] = { ...getTopicState(id), ...patch };
    saveState(state);
    updateStatsAndProgress();
    render();
  }

  function isVerifiedFor(tab, ts){
    return tab === "maths" ? Boolean(ts.quizOk) : Boolean(ts.explainOk);
  }
  function isUnlocked(tab, ts){
    return isVerifiedFor(tab, ts) && ts.conf === "yes";
  }
  function calcEarnedForTopic(tab, ts){
    if(!isVerifiedFor(tab, ts)) return 0;
    let money = REWARD.verified;
    if(ts.conf === "yes") money += REWARD.confidentBonus;
    return money;
  }

  /* ====== UI Rendering ====== */
  const contentEl = document.getElementById("content");
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const searchBox = document.getElementById("searchBox");
  const clearSearchBtn = document.getElementById("clearSearchBtn");

  let activeTab = "maths";
  let searchText = "";

  tabs.forEach(t => on(t, "click", () => {
    tabs.forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    activeTab = t.dataset.tab;
    render();
  }));

  on(searchBox, "input", (e) => {
    searchText = ((e.target && e.target.value) || "").trim().toLowerCase();
    render();
  });
  on(clearSearchBtn, "click", () => {
    searchText = "";
    if(searchBox) searchBox.value = "";
    render();
  });

  function badge(text){
    const span = document.createElement("span");
    span.className = "badge";
    span.textContent = text;
    return span;
  }

  function render(){
    if(!contentEl) return;
    const sections = DATA[activeTab];
    contentEl.innerHTML = "";

    sections.forEach(sec => {
      const filteredItems = sec.items.filter(it => {
        if(!searchText) return true;
        const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
        return hay.includes(searchText);
      });
      if(filteredItems.length === 0) return;

      const details = document.createElement("details");
      details.className = "section";
      details.open = !searchText;

      const summary = document.createElement("summary");
      const left = document.createElement("div");
      left.textContent = sec.section;

      const meta = document.createElement("div");
      meta.className = "sectionMeta";
      const secStats = getSectionStats(activeTab, filteredItems);
      meta.appendChild(badge(`üí∞ ¬£${secStats.money.toFixed(2)}`));
      meta.appendChild(badge(`‚úÖ ${secStats.done}/${filteredItems.length}`));

      summary.appendChild(left);
      summary.appendChild(meta);

      const cards = document.createElement("div");
      cards.className = "cards";
      filteredItems.forEach(it => cards.appendChild(renderCard(it)));

      details.appendChild(summary);
      details.appendChild(cards);
      contentEl.appendChild(details);
    });

    updateStatsAndProgress();
  }

  function checkboxPill(text, checked, onChange){
    const lbl = document.createElement("label");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = checked;
    on(cb, "change", () => onChange(cb.checked));
    const span = document.createElement("span");
    span.textContent = text;
    lbl.appendChild(cb);
    lbl.appendChild(span);
    return lbl;
  }

  /* ---- KEEP YOUR EXISTING renderCard(), tutor chat code, OFFLINE_TUTOR, visuals etc. HERE ---- */
  /* (unchanged ‚Äî paste your existing tutor section exactly as before) */

  /* ====== Stats helpers used above ====== */
  function getAllTopics(){
    const all = [];
    Object.keys(DATA).forEach(k => DATA[k].forEach(sec => sec.items.forEach(it => all.push({ ...it, tab:k }))));
    return all;
  }

  function getSectionStats(tab, items){
    let money = 0;
    let done = 0;
    items.forEach(it => {
      const ts = getTopicState(it.id);
      money += calcEarnedForTopic(tab, ts);
      if(isUnlocked(tab, ts)) done += 1;
    });
    return { money, done };
  }

  function updateStatsAndProgress(){
    const all = getAllTopics();
    let totalMoney = 0;
    let topicsDone = 0;

    all.forEach(it => {
      const ts = getTopicState(it.id);
      totalMoney += calcEarnedForTopic(it.tab, ts);
      if(isUnlocked(it.tab, ts)) topicsDone += 1;
    });

    const totalMoneyEl = document.getElementById("totalMoney");
    const topicsDoneEl = document.getElementById("topicsDone");
    if(totalMoneyEl) totalMoneyEl.textContent = `¬£${totalMoney.toFixed(2)}`;
    if(topicsDoneEl) topicsDoneEl.textContent = `${topicsDone}`;

    const visible = [];
    DATA[activeTab].forEach(sec => sec.items.forEach(it => {
      if(!searchText) { visible.push(it); return; }
      const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
      if(hay.includes(searchText)) visible.push(it);
    }));

    const totalVisible = visible.length || 1;
    let doneVisible = 0;
    visible.forEach(it => {
      const ts = getTopicState(it.id);
      if(isUnlocked(activeTab, ts)) doneVisible += 1;
    });

    const pct = Math.round((doneVisible / totalVisible) * 100);
    const fill = document.getElementById("progressFill");
    const pctEl = document.getElementById("progressPct");
    if(fill) fill.style.width = `${pct}%`;
    if(pctEl) pctEl.textContent = `${pct}%`;
  }

  /* ---------- SAFE SELF TESTS (NEVER BREAK UI) ---------- */
  function assert(condition, message){
    if(!condition) throw new Error(message);
  }
  function runSelfTestsSafe(){
    try{
      // Only run if helper exists in your full code
      if(typeof highlightCapsVisual === "function"){
        const html = highlightCapsVisual("we visited zimbabwe in april.");
        assert(typeof html === "string" && html.includes("zimbabwe"), "highlightCapsVisual should return HTML");
      }
      render();
      assert(document.querySelectorAll("details.section").length > 0, "render should create at least one section");
      assert(on(null, "click", () => {}) === false, "on() should return false for null");
      console.log("‚úÖ Self-tests passed");
    }catch(e){
      console.warn("‚ö†Ô∏è Self-tests failed (non-fatal):", e.message || e);
    }
  }

  // Run tests ONLY if you add ?test=1
  if(new URLSearchParams(location.search).get("test") === "1"){
    runSelfTestsSafe();
  }

  /* Initial render (always) */
  render();

});
</script>
