<script>
// ================== Small safety helper ==================
// Prevents crashes if any element is missing (e.g., after UI edits)
function on(el, event, handler){
  if(!el) return false;
  el.addEventListener(event, handler);
  return true;
}

// ====== REWARD SETTINGS ======
const REWARD = {
  verified: 1.25,
  confidentBonus: 0.25
};

// ====== Confidence Options ======
const CONF_OPTIONS = [
  { value: "not", label: "üòü Not confident" },
  { value: "some", label: "üôÇ Getting there" },
  { value: "yes", label: "üòÑ Very confident" }
];

// ====== DATA (Maths + English) ======
const DATA = {
  maths: [
    { section: "Number & Place Value", items: [
      { id:"m_N1", topic:"Counting in multiples (input/output tables)", code:"N1 ‚Ä¢ 6V2" },
      { id:"m_N2", topic:"Ten more or less / compare & order numbers to 10 million", code:"N2 ‚Ä¢ BYZ/9MH" },
      { id:"m_N2b", topic:"Write numbers up to 10 million in words", code:"N2 ‚Ä¢ 84X" },
      { id:"m_N3", topic:"Expanded form & Roman numerals", code:"N3 ‚Ä¢ ATH/BAK" },
      { id:"m_N4", topic:"Rounding (up to millions place)", code:"N4 ‚Ä¢ X65" },
      { id:"m_N5", topic:"Negative numbers (integers)", code:"N5 ‚Ä¢ 7SS" },
      { id:"m_N6", topic:"Place value word problems", code:"N6 ‚Ä¢ DGS" }
    ]},
    { section: "Calculations (Add/Subtract/Multiply/Divide)", items: [
      { id:"m_C1", topic:"Mental add/subtract with zeros", code:"C1 ‚Ä¢ YCD" },
      { id:"m_C2a", topic:"Add numbers up to six digits", code:"C2 ‚Ä¢ KNF" },
      { id:"m_C2b", topic:"Subtract numbers up to six digits", code:"C2 ‚Ä¢ FHZ" },
      { id:"m_C3", topic:"Estimate & check answers (reasonable answers)", code:"C3 ‚Ä¢ 49F" },
      { id:"m_C4", topic:"Multi-step add/subtract word problems", code:"C4 ‚Ä¢ 6NM" },
      { id:"m_C5", topic:"Factors, multiples, primes (incl HCF/LCM)", code:"C5 ‚Ä¢ Q9A/74F/WNB" },
      { id:"m_C6", topic:"Multiply/divide mentally with zeros", code:"C6 ‚Ä¢ 9BT" },
      { id:"m_C7a", topic:"Multiply 2-digit by 3/4-digit", code:"C7 ‚Ä¢ 5G6" },
      { id:"m_C7b", topic:"Divide 4-digit by 2-digit (and word problems)", code:"C7 ‚Ä¢ BY7/48X" },
      { id:"m_C8", topic:"Multi-step problems using all operations", code:"C8 ‚Ä¢ JFJ" },
      { id:"m_C9", topic:"Order of operations (brackets/square brackets)", code:"C9 ‚Ä¢ 9PZ" }
    ]},
    { section: "Fractions, Decimals & Percentages", items: [
      { id:"m_F2", topic:"Equivalent fractions & simplest form", code:"F2 ‚Ä¢ MP2/FXV" },
      { id:"m_F3", topic:"Compare & order fractions", code:"F3 ‚Ä¢ BF9" },
      { id:"m_F4", topic:"Add/subtract fractions with different denominators", code:"F4 ‚Ä¢ UW7" },
      { id:"m_F5", topic:"Multiply fractions / divide fractions by whole numbers", code:"F5 ‚Ä¢ YB2/A2R" },
      { id:"m_F6", topic:"Convert fractions to decimals", code:"F6 ‚Ä¢ 4K2" },
      { id:"m_F7", topic:"Round decimals", code:"F7 ‚Ä¢ LXK" },
      { id:"m_F8", topic:"Compare & order decimals to thousandths", code:"F8 ‚Ä¢ U6K/ASD" },
      { id:"m_F9", topic:"Multiply/divide decimals (10/100/1000 etc.)", code:"F9 ‚Ä¢ WJ8/PZB/CNS/9DZ" },
      { id:"m_F10", topic:"Decimal word problems & rounding", code:"F10 ‚Ä¢ YTU/LKL" },
      { id:"m_F11", topic:"Convert between percents, fractions & decimals (word problems)", code:"F11 ‚Ä¢ TND" },
      { id:"m_F12", topic:"Percentage problems & comparisons", code:"F12 ‚Ä¢ CGZ/FHN" }
    ]},
    { section: "Ratio, Proportion & Algebra", items: [
      { id:"m_R1", topic:"Ratios and rates word problems", code:"R1 ‚Ä¢ EKA" },
      { id:"m_R2", topic:"Percent of a number & comparing percents", code:"R2 ‚Ä¢ QLE/49P" },
      { id:"m_R3", topic:"Scale drawings / scale factors word problems", code:"R3 ‚Ä¢ R99" },
      { id:"m_R4", topic:"Fractions of a number & multiplicative comparison", code:"R4 ‚Ä¢ APR/ZML" },
      { id:"m_A1", topic:"One-step equations from diagrams", code:"A1 ‚Ä¢ Z7D" },
      { id:"m_A2", topic:"Write variable expressions (word problems)", code:"A2 ‚Ä¢ ZU2" },
      { id:"m_A3", topic:"Number sequences (use a rule)", code:"A3 ‚Ä¢ PWX" },
      { id:"m_A4", topic:"Does (x, y) satisfy an equation?", code:"A4 ‚Ä¢ UHF" },
      { id:"m_A5", topic:"Two-variable tables / relationships", code:"A5 ‚Ä¢ BKG" }
    ]},
    { section: "Measurement", items: [
      { id:"m_M5", topic:"Convert metric units", code:"M5 ‚Ä¢ XHY" },
      { id:"m_M2", topic:"Measure using a ruler & choose appropriate units", code:"M2 ‚Ä¢ EWK/MKW/Z6G/D98" },
      { id:"m_M3", topic:"Money (count coins/notes)", code:"M3 ‚Ä¢ XZZ" },
      { id:"m_M4", topic:"Time conversions + start/end time problems", code:"M4 ‚Ä¢ 6BE/NWK" },
      { id:"m_M6", topic:"Convert miles and kilometres", code:"M6 ‚Ä¢ EMG" },
      { id:"m_M7", topic:"Area & perimeter (incl triangles/parallelograms)", code:"M7 ‚Ä¢ SCN/9GQ" },
      { id:"m_M8", topic:"Volume of cubes/cuboids", code:"M8 ‚Ä¢ M7H" },
      { id:"m_M9", topic:"Multi-step measurement conversion problems", code:"M9 ‚Ä¢ MDK" }
    ]},
    { section: "Geometry & Statistics", items: [
      { id:"m_G1", topic:"Properties of polygons", code:"G1 ‚Ä¢ ZQC" },
      { id:"m_G2", topic:"Classify triangles and quadrilaterals", code:"G2 ‚Ä¢ BT2/MJ2" },
      { id:"m_G3", topic:"Draw quadrilaterals & 3D nets", code:"G3 ‚Ä¢ BMN/LB8" },
      { id:"m_G4", topic:"Measure/draw angles + missing angles", code:"G4 ‚Ä¢ X8P/L2F/VLL/59J" },
      { id:"m_G5", topic:"Parts of a circle", code:"G5 ‚Ä¢ PGE" },
      { id:"m_P2", topic:"Translations & reflections on grids", code:"P2 ‚Ä¢ U6P/YR8" },
      { id:"m_P3", topic:"Coordinate plane & quadrants", code:"P3 ‚Ä¢ B45/MZM" },
      { id:"m_S1", topic:"Interpret pie charts & create line graphs", code:"S1 ‚Ä¢ DDW/YJT" },
      { id:"m_S2", topic:"Interpret pictograms/bar/line graphs (multi-step)", code:"S2 ‚Ä¢ KZS/9AG/JUJ" },
      { id:"m_S3", topic:"Mean average from charts", code:"S3 ‚Ä¢ 7DZ" }
    ]}
  ],

  english: [
    { section: "Reading (SATs skills)", items: [
      { id:"e_2a", topic:"Meaning of words in context", code:"2a ‚Ä¢ LZY" },
      { id:"e_2b_lit", topic:"Retrieve/record key details (literary texts)", code:"2b ‚Ä¢ XXT/S9R" },
      { id:"e_2b_info", topic:"Retrieve/record key details (informational texts)", code:"2b ‚Ä¢ J88/GNY" },
      { id:"e_2c", topic:"Summarise main ideas & order events", code:"2c ‚Ä¢ UHG/YL5" },
      { id:"e_2d", topic:"Inferences + evidence (supporting details)", code:"2d ‚Ä¢ 2ZT/S6H/7YR/AVC" },
      { id:"e_2e", topic:"Predict what might happen (stated + implied)", code:"2e ‚Ä¢ 77K" },
      { id:"e_2f", topic:"Text structure (story elements/cause-effect/problem-solution)", code:"2f ‚Ä¢ 4Q6/7EF/GWK/DR5/Q9H" },
      { id:"e_2g", topic:"Word choice & meaning (connotation/sensory/figurative language)", code:"2g ‚Ä¢ QT6/FKF/TNH/2NX" },
      { id:"e_2h", topic:"Compare within a text (viewpoints/characters/info)", code:"2h ‚Ä¢ 29Q/ZK9/UYK" }
    ]},
    { section: "Grammar: Word Classes", items: [
      { id:"g_nouns", topic:"Nouns (incl abstract, possessives)", code:"G1.1 ‚Ä¢ 8XL/EXU/NH9" },
      { id:"g_verbs", topic:"Verbs (action, helping, modal meaning)", code:"G1.2 ‚Ä¢ PLX/Y78/5QD" },
      { id:"g_adj", topic:"Adjectives (identify + compare)", code:"G1.3 ‚Ä¢ YJ5/ANG" },
      { id:"g_conj", topic:"Conjunctions (coordinating/subordinating)", code:"G1.4 ‚Ä¢ 6ES/Q83" },
      { id:"g_pron", topic:"Pronouns (subject/object)", code:"G1.5 ‚Ä¢ M67/QD8" },
      { id:"g_adv", topic:"Adverbs (identify + compare)", code:"G1.6 ‚Ä¢ CWX/BVY" },
      { id:"g_prep", topic:"Prepositions", code:"G1.7 ‚Ä¢ 7C7" },
      { id:"g_det", topic:"Determiners (articles)", code:"G1.8 ‚Ä¢ M5L" },
      { id:"g_subobj", topic:"Subject and object (complete subject)", code:"G1.9 ‚Ä¢ ZWS" }
    ]},
    { section: "Sentence Types & Clauses", items: [
      { id:"g_senttypes", topic:"Statements/questions/commands/exclamations", code:"G2 ‚Ä¢ PWA" },
      { id:"g_clauses", topic:"Dependent vs independent clauses", code:"G3.1 ‚Ä¢ YDH" },
      { id:"g_nounphr", topic:"Noun phrases (adjective order, more/most)", code:"G3.2 ‚Ä¢ BRZ/SL8" },
      { id:"g_coord", topic:"Co-ordinating conjunctions (use correctly)", code:"G3.3 ‚Ä¢ CPS" },
      { id:"g_subord", topic:"Subordinating conjunctions + subordinate clauses", code:"G3.4 ‚Ä¢ FZC" }
    ]},
    { section: "Tense & Consistency", items: [
      { id:"g_tense", topic:"Tense consistency (fix tense shifts)", code:"G4.2 ‚Ä¢ 9MP" }
    ]},
    { section: "Punctuation", items: [
      { id:"p_caps", topic:"Capital letters (fix capitalisation)", code:"G5.1 ‚Ä¢ H7T" },
      { id:"p_endmarks", topic:"Full stops, question marks, exclamation marks", code:"G5.2‚Äì5.4 ‚Ä¢ PWA" },
      { id:"p_quotes", topic:"Inverted commas (titles/formatting)", code:"G5.7 ‚Ä¢ RJZ" },
      { id:"p_apost", topic:"Apostrophes: contractions + possessives", code:"G5.8 ‚Ä¢ SK5/9ME/SP7" },
      { id:"p_dashes", topic:"Dashes", code:"G5.12 ‚Ä¢ URX" }
    ]},
    { section: "Vocabulary & Spelling", items: [
      { id:"v_syn", topic:"Synonyms & antonyms in context", code:"G6.1 ‚Ä¢ WVB/2TL" },
      { id:"v_pref", topic:"Prefixes (re-, mis-, un-/dis-/in-/im-/non-)", code:"G6.2 ‚Ä¢ KUW/UMV/A5X" },
      { id:"v_suf", topic:"Suffixes (-ful, -less) + plurals review", code:"G6.3 ‚Ä¢ 32W/9ML/FKY" },
      { id:"v_roots", topic:"Word families (Greek/Latin roots)", code:"G6.4 ‚Ä¢ 9Z5/8A6" },
      { id:"s_excepts", topic:"Common exception words (patterns like -ild/-ind etc.)", code:"S37 ‚Ä¢ A9C" },
      { id:"s_diph", topic:"Diphthongs (oi/oy/ou/ow)", code:"S40 ‚Ä¢ LT9" },
      { id:"s_digraph", topic:"Digraphs (ch/sh/th)", code:"S48‚Äì49 ‚Ä¢ LN7" },
      { id:"s_silent", topic:"Silent letters", code:"S60 ‚Ä¢ FYB" },
      { id:"s_homo", topic:"Homophones", code:"S61 ‚Ä¢ 7QU" }
    ]}
  ]
};

// ====== Storage ======
const STORAGE_KEY = "micaela_ks2_checklist_v2_verified";

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return {};
    return JSON.parse(raw);
  }catch(e){
    return {};
  }
}
function saveState(nextState){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(nextState));
}

let state = loadState();
// state per topic: { conf, practice, quizOk, explainOk }

function getTopicState(id){
  return state[id] || { conf:"some", practice:false, quizOk:false, explainOk:false };
}
function setTopicState(id, patch){
  state[id] = { ...getTopicState(id), ...patch };
  saveState(state);
  updateStatsAndProgress();
  render();
}

function isVerifiedFor(tab, ts){
  return tab === "maths" ? Boolean(ts.quizOk) : Boolean(ts.explainOk);
}
function isUnlocked(tab, ts){
  return isVerifiedFor(tab, ts) && ts.conf === "yes";
}
function calcEarnedForTopic(tab, ts){
  if(!isVerifiedFor(tab, ts)) return 0;
  let money = REWARD.verified;
  if(ts.conf === "yes") money += REWARD.confidentBonus;
  return money;
}

// ====== UI Rendering ======
const contentEl = document.getElementById("content");
const tabs = Array.from(document.querySelectorAll(".tab"));
const searchBox = document.getElementById("searchBox");
const clearSearchBtn = document.getElementById("clearSearchBtn");

let activeTab = "maths";
let searchText = "";

tabs.forEach(t => on(t, "click", () => {
  tabs.forEach(x => x.classList.remove("active"));
  t.classList.add("active");
  activeTab = t.dataset.tab;
  render();
}));

on(searchBox, "input", (e) => {
  searchText = ((e.target && e.target.value) || "").trim().toLowerCase();
  render();
});
on(clearSearchBtn, "click", () => {
  searchText = "";
  if(searchBox) searchBox.value = "";
  render();
});

function badge(text){
  const span = document.createElement("span");
  span.className = "badge";
  span.textContent = text;
  return span;
}

function render(){
  if(!contentEl) return;
  const sections = DATA[activeTab];
  contentEl.innerHTML = "";

  sections.forEach(sec => {
    const filteredItems = sec.items.filter(it => {
      if(!searchText) return true;
      const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
      return hay.includes(searchText);
    });
    if(filteredItems.length === 0) return;

    const details = document.createElement("details");
    details.className = "section";
    details.open = !searchText;

    const summary = document.createElement("summary");
    const left = document.createElement("div");
    left.textContent = sec.section;

    const meta = document.createElement("div");
    meta.className = "sectionMeta";
    const secStats = getSectionStats(activeTab, filteredItems);
    meta.appendChild(badge(`üí∞ ¬£${secStats.money.toFixed(2)}`));
    meta.appendChild(badge(`‚úÖ ${secStats.done}/${filteredItems.length}`));

    summary.appendChild(left);
    summary.appendChild(meta);

    const cards = document.createElement("div");
    cards.className = "cards";
    filteredItems.forEach(it => cards.appendChild(renderCard(it)));

    details.appendChild(summary);
    details.appendChild(cards);
    contentEl.appendChild(details);
  });

  updateStatsAndProgress();
}

function checkboxPill(text, checked, onChange){
  const lbl = document.createElement("label");
  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.checked = checked;
  on(cb, "change", () => onChange(cb.checked));
  const span = document.createElement("span");
  span.textContent = text;
  lbl.appendChild(cb);
  lbl.appendChild(span);
  return lbl;
}

function renderCard(item){
  const ts = getTopicState(item.id);

  const card = document.createElement("div");
  card.className = "card";

  const row1 = document.createElement("div");
  row1.className = "row1";

  const topic = document.createElement("div");
  topic.className = "topic";
  topic.textContent = item.topic;

  const code = document.createElement("div");
  code.className = "code";
  code.textContent = item.code || "";

  row1.appendChild(topic);
  row1.appendChild(code);

  const controls = document.createElement("div");
  controls.className = "controls";

  const confWrap = document.createElement("div");
  confWrap.className = "conf";
  const confLabel = document.createElement("label");
  confLabel.textContent = "Confidence:";
  const sel = document.createElement("select");
  CONF_OPTIONS.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    sel.appendChild(o);
  });
  sel.value = ts.conf;
  on(sel, "change", () => setTopicState(item.id, { conf: sel.value }));
  confWrap.appendChild(confLabel);
  confWrap.appendChild(sel);

  const checks = document.createElement("div");
  checks.className = "checks";
  checks.appendChild(checkboxPill("IXL practice done", ts.practice, (val) => setTopicState(item.id, { practice: val })));

  const askBtn = document.createElement("button");
  askBtn.className = "askBtn";
  askBtn.type = "button";
  askBtn.textContent = activeTab === "maths" ? "ü©∑ Take Tutor Quiz" : "ü©∑ Explain-back to Tutor";
  on(askBtn, "click", () => {
    setCurrentTopic(item);
    openTutor();
    if(activeTab === "maths"){
      botSay(`Hi Micaela üíñ\nTo unlock money for ‚Äú${item.topic}‚Äù, pass the Tutor quiz ‚úÖ\nTap Quick Quiz or type: quiz`);
    } else {
      botSay(`Hi Micaela üíñ\nTo unlock money for ‚Äú${item.topic}‚Äù, explain it back in your own words ‚úÖ\nTap Explain-back or type: explain-back`);
    }
  });

  controls.appendChild(confWrap);
  controls.appendChild(checks);
  controls.appendChild(askBtn);

  const pills = document.createElement("div");
  pills.className = "pills";

  const verified = isVerifiedFor(activeTab, ts);
  const needed = activeTab === "maths" ? "Quiz" : "Explain-back";
  const unlocked = isUnlocked(activeTab, ts);

  const vChip = document.createElement("span");
  vChip.className = "chip2";
  vChip.textContent = verified ? `‚úÖ ${needed} verified` : `üîí ${needed} not verified`;

  const cChip = document.createElement("span");
  cChip.className = "chip2";
  cChip.textContent = (ts.conf === "yes") ? "üòÑ Confidence set" : "üôÇ Set confidence to üòÑ";

  const uChip = document.createElement("span");
  uChip.className = "chip2";
  uChip.textContent = unlocked ? "üí∞ Reward unlocked" : "‚è≥ Reward locked";

  pills.appendChild(vChip);
  pills.appendChild(cChip);
  pills.appendChild(uChip);

  const earnedRow = document.createElement("div");
  earnedRow.className = "earnedRow";
  const earnedAmt = calcEarnedForTopic(activeTab, ts);

  const tag1 = document.createElement("span");
  tag1.className = "tagEarned";
  tag1.textContent = `üí∏ Earned: ¬£${earnedAmt.toFixed(2)}`;

  const tag2 = document.createElement("span");
  tag2.className = "tagEarned";
  tag2.textContent = unlocked ? "üåü Unlocked!" : "‚è≥ Keep going";

  earnedRow.appendChild(tag1);
  earnedRow.appendChild(tag2);

  card.appendChild(row1);
  card.appendChild(controls);
  card.appendChild(pills);
  card.appendChild(earnedRow);

  return card;
}

function getAllTopics(){
  const all = [];
  Object.keys(DATA).forEach(k => DATA[k].forEach(sec => sec.items.forEach(it => all.push({ ...it, tab:k }))));
  return all;
}

function getSectionStats(tab, items){
  let money = 0;
  let done = 0;
  items.forEach(it => {
    const ts = getTopicState(it.id);
    money += calcEarnedForTopic(tab, ts);
    if(isUnlocked(tab, ts)) done += 1;
  });
  return { money, done };
}

function updateStatsAndProgress(){
  const all = getAllTopics();
  let totalMoney = 0;
  let topicsDone = 0;

  all.forEach(it => {
    const ts = getTopicState(it.id);
    totalMoney += calcEarnedForTopic(it.tab, ts);
    if(isUnlocked(it.tab, ts)) topicsDone += 1;
  });

  const totalMoneyEl = document.getElementById("totalMoney");
  const topicsDoneEl = document.getElementById("topicsDone");
  if(totalMoneyEl) totalMoneyEl.textContent = `¬£${totalMoney.toFixed(2)}`;
  if(topicsDoneEl) topicsDoneEl.textContent = `${topicsDone}`;

  // progress bar = unlocked topics (in current view + search)
  const visible = [];
  DATA[activeTab].forEach(sec => sec.items.forEach(it => {
    if(!searchText) { visible.push(it); return; }
    const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
    if(hay.includes(searchText)) visible.push(it);
  }));

  const totalVisible = visible.length || 1;
  let doneVisible = 0;
  visible.forEach(it => {
    const ts = getTopicState(it.id);
    if(isUnlocked(activeTab, ts)) doneVisible += 1;
  });

  const pct = Math.round((doneVisible / totalVisible) * 100);
  const fill = document.getElementById("progressFill");
  const pctEl = document.getElementById("progressPct");
  if(fill) fill.style.width = `${pct}%`;
  if(pctEl) pctEl.textContent = `${pct}%`;
}

// ====== Export / Import / Reset ======
const resetBtn = document.getElementById("resetBtn");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");

on(resetBtn, "click", () => {
  if(!confirm("Reset ALL progress? This will clear practice, confidence, and tutor verification.")) return;
  state = {};
  saveState(state);
  render();
});

on(exportBtn, "click", () => {
  const payload = {
    version: 2,
    exportedAt: new Date().toISOString(),
    reward: REWARD,
    state
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "micaela-checklist-progress.json";
  a.click();
  URL.revokeObjectURL(url);
});

on(importBtn, "click", async () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      if(!parsed || typeof parsed !== "object" || !parsed.state) throw new Error("Invalid file");
      state = parsed.state || {};
      saveState(state);
      render();
      alert("Imported! üéâ");
    }catch(e){
      alert("Sorry ‚Äî that file didn‚Äôt look like a valid export.");
    }
  };
  input.click();
});

// ===== Tutor Chat (AI first + offline fallback) =====
const tutorPanel = document.getElementById("tutorPanel");
const tutorFab = document.getElementById("tutorFab");
const tutorTopicEl = document.getElementById("tutorTopic");
const chatLog = document.getElementById("chatLog");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const passSupportive = document.getElementById("passSupportive");
const closeTutor = document.getElementById("closeTutor");

const qExplain = document.getElementById("qExplain");
const qExample = document.getElementById("qExample");
const qQuiz = document.getElementById("qQuiz");
const qExplainBack = document.getElementById("qExplainBack");
const qVisual = document.getElementById("qVisual");

// Your Cloudflare Worker endpoint:
const AI_API_URL = "https://ai-study-coach-backend.tmanyepa.workers.dev/api/chat";

// AI memory (so tutor can remember a bit)
let tutorHistory = [];
let lastQuickAction = "";

let passMode = "supportive"; // supportive (A mode)
let currentTopic = null;   // {id, topic, code}

function openTutor(){ if(tutorPanel) tutorPanel.classList.add("open"); }
function closeTutorPanel(){ if(tutorPanel) tutorPanel.classList.remove("open"); }

function setPassMode(next){
  passMode = next;
  if(passSupportive) passSupportive.classList.toggle("active", passMode === "supportive");
  if(passMode === "supportive"){
    botSay("A Mode ‚úÖ\nI will be kind and accept \"close enough\" if your understanding is clear üíñ\nI may ask you to add a quick example.");
  }
}

function setCurrentTopic(item){
  currentTopic = item;
  if(tutorTopicEl) tutorTopicEl.textContent = `Topic: ${item.topic}`;

  // Reset tutor state when topic changes (prevents mixing topics)
  tutorHistory = [];
  lastQuickAction = "";
  tutorExpected = null;
  tutorExpectedType = null;
}

function addMsg(role, text){
  if(!chatLog) return null;
  const row = document.createElement("div");
  row.className = `msg ${role}`;
  const b = document.createElement("div");
  b.className = "bubble";
  b.textContent = text;
  row.appendChild(b);
  chatLog.appendChild(row);
  chatLog.scrollTop = chatLog.scrollHeight;
  return row;
}
function botSay(text){ addMsg("bot", text); }
function userSay(text){ addMsg("user", text); }

function botTyping(){
  const row = addMsg("bot", "Typing‚Ä¶");
  const bubble = row ? row.querySelector(".bubble") : null;
  return (finalText) => {
    if(bubble){
      bubble.textContent = finalText;
      if(chatLog) chatLog.scrollTop = chatLog.scrollHeight;
    } else {
      botSay(finalText);
    }
  };
}

function ensureTopicSelected(){
  if(currentTopic) return true;
  botSay("Pick a topic first üíñ Tap ‚ÄòTake Tutor Quiz‚Äô (Maths) or ‚ÄòExplain-back‚Äô (English) on a topic card.");
  return false;
}

function getTutorContext(){
  const subject = activeTab === "maths" ? "maths" : "english";
  const mode =
    (activeTab === "maths")
      ? (String(currentTopic?.topic || "").toLowerCase().includes("times") ? "timetables" : "maths")
      : "english";
  return { subject, mode };
}

async function callStudyCoachAPI(message, history = [], subject = "", mode = ""){
  const res = await fetch(AI_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message, history, subject, mode })
  });

  const data = await res.json().catch(() => ({}));
  if(!res.ok) throw new Error(data?.error || data?.details || "API error");
  return data.reply || "";
}

// ---- A Mode (Supportive marking) ----
function evaluateExplainBack(rawText, expected){
  const text = String(rawText || "").trim();
  const low = text.toLowerCase();

  const hasReason = /\bbecause\b|\bso\b|\bthis shows\b|\bthat means\b|\bso that\b|\btherefore\b/.test(low);
  const hasExample = /\bfor example\b|\beg\b|\be\.g\.|\blike\b|\bfor instance\b|\"/.test(low);
  const longEnough = text.length >= 28;

  const mustAny = (expected?.mustIncludeAny || []).map(s => String(s).toLowerCase());
  const niceAny = (expected?.niceToIncludeAny || []).map(s => String(s).toLowerCase());

  const hitsMust = mustAny.filter(k => k && low.includes(k));
  const hitsNice = niceAny.filter(k => k && low.includes(k));

  let score = 0;
  if(longEnough) score += 1;
  if(hasReason) score += 2;
  if(hasExample) score += 1;
  if(hitsMust.length >= 1) score += 1;
  if(hitsMust.length >= 2) score += 1;
  if(hitsNice.length >= 1) score += 1;

  const coreIdea = (hitsMust.length >= 1) || (hitsNice.length >= 2);
  const ok = (coreIdea && hasReason) || (coreIdea && hasExample && longEnough) || (score >= 4 && (hasReason || hasExample));

  let feedback = "";
  if(!ok){
    const needs = [];
    if(!longEnough) needs.push("a bit more detail (1‚Äì2 more sentences)");
    if(!hasReason) needs.push("a *because* (why it works / why it means that)");
    if(!hasExample) needs.push("a quick example");
    feedback = `Almost üíñ ‚Äî you‚Äôre close! Please add:\n‚Ä¢ ${needs.slice(0,3).join("\n‚Ä¢ ")}\nThen send again ‚ú®`;
  }

  return { ok, score, hitsMust, hitsNice, hasReason, hasExample, longEnough, feedback };
}

// ---- Offline tutor packs ----
const OFFLINE_TUTOR = {
  // Maths
  "Counting in multiples (input/output tables)": {
    explain: "Counting in multiples means jumping by the same number each time (like +2, +5, +10).\nInput/output tables show a rule that turns an input into an output.",
    example: "If the rule is √ó3, then:\nInput 2 ‚Üí Output 6\nInput 4 ‚Üí Output 12\nTry: Input 5 ‚Üí Output ?",
    quiz: { q:"Rule is +7. If input is 9, what is output?", a:"16" },
    visual: () => numberLineVisual(0, 35, 7)
  },
  "Equivalent fractions & simplest form": {
    explain: "Equivalent fractions are the same value written in different ways.\nYou can multiply or divide the top and bottom by the SAME number.",
    example: "1/2 is the same as 2/4 and 3/6.\nBecause we multiplied top & bottom by 2 or 3.",
    quiz: { q:"Is 3/6 equivalent to 1/2? (yes/no)", a:"yes" },
    visual: () => fractionBarVisual(1,2)
  },
  "Compare & order fractions": {
    explain: "To compare fractions:\n‚Ä¢ If denominators match, bigger numerator is bigger.\n‚Ä¢ If not, convert to a common denominator or use fraction bars.",
    example: "Compare 1/3 and 1/2.\nHalf is bigger because 1 out of 2 is larger than 1 out of 3.",
    quiz: { q:"Which is bigger: 3/4 or 2/3?", a:"3/4" },
    visual: () => fractionCompareVisual(3,4,2,3)
  },
  "Place value word problems": {
    explain: "Place value tells you what each digit is worth (ones, tens, hundreds, thousands‚Ä¶).\nWord problems often ask you to use that to compare or calculate.",
    example: "In 54,321 the 5 is 50,000 and the 3 is 300.",
    quiz: { q:"In 7,205 what is the value of the 2?", a:"200" },
    visual: () => placeValueVisual("7205")
  },

  // English
  "Inferences + evidence (supporting details)": {
    explain: "Inference means you use clues + what you know to figure something out that isn‚Äôt said directly.\nEvidence is the words from the text that prove your idea.",
    example: "Text: ‚ÄòSam pulled on his coat and shivered.‚Äô\nInference: It is cold.\nEvidence: ‚Äòpulled on his coat‚Äô + ‚Äòshivered‚Äô.",
    explainBack: {
      prompt: "Explain what an inference is AND what evidence is. Use your own words.",
      mustIncludeAny: ["clue","proof","evidence","because","text"],
      niceToIncludeAny: ["infer","figure out","not said","implied"]
    },
    visual: () => clueBubbleVisual(["pulled on coat","shivered"], "It is cold")
  },
  "Capital letters (fix capitalisation)": {
    explain: "Use capital letters for:\n‚Ä¢ Start of a sentence\n‚Ä¢ Names (people/places)\n‚Ä¢ Days/months\n‚Ä¢ ‚ÄòI‚Äô\n‚Ä¢ Titles (sometimes)",
    example: "Wrong: i went to london on monday.\nRight: I went to London on Monday.",
    explainBack: {
      prompt: "Explain when we use capital letters. Give at least 2 rules.",
      mustIncludeAny: ["start","sentence","name","i","day","month","place"],
      niceToIncludeAny: ["person","proper noun","title"]
    },
    visual: () => highlightCapsVisual("we visited zimbabwe in april.")
  }
};

function getOfflinePack(topicName){
  if(OFFLINE_TUTOR[topicName]) return OFFLINE_TUTOR[topicName];
  const key = Object.keys(OFFLINE_TUTOR).find(k => topicName.toLowerCase().includes(k.toLowerCase().slice(0,12)));
  return key ? OFFLINE_TUTOR[key] : null;
}

function renderVisual(fn){
  if(!chatLog) return;
  const wrap = document.createElement("div");
  wrap.className = "miniVisual";
  wrap.innerHTML = fn();

  const row = document.createElement("div");
  row.className = "msg bot";
  const b = document.createElement("div");
  b.className = "bubble";
  b.textContent = "Here‚Äôs a visual:";
  row.appendChild(b);

  chatLog.appendChild(row);
  chatLog.appendChild(wrap);
  chatLog.scrollTop = chatLog.scrollHeight;
}

let tutorExpected = null;
let tutorExpectedType = null; // quiz | explainBack

function markVerified(){
  if(!currentTopic) return;
  if(activeTab === "maths") setTopicState(currentTopic.id, { quizOk:true });
  else setTopicState(currentTopic.id, { explainOk:true });
}

function handleOffline(message){
  if(!ensureTopicSelected()) return;
  const pack = getOfflinePack(currentTopic.topic);

  // Handle quiz answers
  if(tutorExpectedType === "quiz" && tutorExpected){
    const ans = message.trim().toLowerCase();
    const exp = String(tutorExpected).trim().toLowerCase();
    if(ans === exp){
      botSay("‚úÖ YESSS! That‚Äôs correct! üåü\nI‚Äôve verified this topic.");
      if(activeTab === "maths"){
        markVerified();
        botSay("Now set confidence to üòÑ to unlock money üí∞");
      } else {
        botSay("(For English, verification is Explain-back. Tap Explain-back.)");
      }
    } else {
      botSay(`Almost! üíñ The answer is: ${tutorExpected}.\nWant me to explain why?`);
    }
    tutorExpected = null;
    tutorExpectedType = null;
    return;
  }

  // Handle explain-back submission
  if(tutorExpectedType === "explainBack" && tutorExpected){
    const result = evaluateExplainBack(message, tutorExpected);

    if(result.ok){
      botSay("‚úÖ Great explain-back! That shows understanding üåü\nI‚Äôve verified this topic.");
      if(activeTab === "english"){
        markVerified();
        botSay("Now set confidence to üòÑ to unlock money üí∞");
      }
      tutorExpected = null;
      tutorExpectedType = null;
      return;
    }

    botSay(result.feedback);
    if(tutorExpected?.mustIncludeAny?.length){
      botSay(`Hint words: ${tutorExpected.mustIncludeAny.slice(0,6).join(", ")}${tutorExpected.mustIncludeAny.length>6?"‚Ä¶":""}`);
    }
    return;
  }

  // No pack? fallback
  if(!pack){
    botSay(`I can help with ‚Äú${currentTopic.topic}‚Äù üíñ\nTell me what feels tricky and I‚Äôll explain step-by-step.`);
    if(/visual|draw|show/i.test(message)) renderVisual(() => simpleStepsVisual(["What is it?","How do we do it?","Try 1 example","Quick check"]));
    return;
  }

  // Commands
  if(/explain-back|explain back|teach/i.test(message)){
    if(activeTab !== "english"){
      botSay("Explain-back is mainly for English ‚úÖ\nFor Maths, use Quick Quiz.");
      return;
    }
    if(!pack.explainBack){
      botSay("Let‚Äôs do explain-back üíñ\nExplain this topic in your own words. Include at least 2 key ideas.");
      tutorExpected = { mustIncludeAny:["because","rule","example"], niceToIncludeAny:[] };
      tutorExpectedType = "explainBack";
      return;
    }
    botSay("Explain-back ‚úÖ\n" + pack.explainBack.prompt);
    tutorExpected = pack.explainBack;
    tutorExpectedType = "explainBack";
    return;
  }

  if(/quiz|question|test/i.test(message)){
    if(activeTab !== "maths"){
      botSay("For English, verification is Explain-back ‚úÖ\nTap Explain-back.");
      return;
    }
    if(!pack.quiz){
      botSay("Quick quiz ‚ú®\n(This topic doesn‚Äôt have a built-in quiz yet ‚Äî we can add one.)");
      return;
    }
    botSay("Quick quiz ‚ú®\n" + pack.quiz.q);
    botSay("Reply with your answer.");
    tutorExpected = pack.quiz.a;
    tutorExpectedType = "quiz";
    return;
  }

  if(/example|show me/i.test(message)){
    botSay(pack.example || "Here‚Äôs a simple example: try one step at a time.");
    return;
  }

  if(/visual|draw|picture|diagram/i.test(message)){
    if(pack.visual) renderVisual(pack.visual);
    else renderVisual(() => simpleStepsVisual(["What is it?","Key rule","Try example","Check answer"]));
    return;
  }

  // Default explain
  botSay(pack.explain || "Let‚Äôs break it down into small steps üíñ");
}

// ‚úÖ AI-first sendChat (fallback to offline)
async function sendChat(text){
  const msg = (text ?? (chatInput ? chatInput.value : "")).trim();
  if(!msg) return;

  userSay(msg);
  if(chatInput) chatInput.value = "";

  if(!ensureTopicSelected()) return;

  const finishTyping = botTyping();

  const { subject, mode } = getTutorContext();
  const topicLine = currentTopic ? `Topic: ${currentTopic.topic}` : "";
  const quick = lastQuickAction ? `Quick action: ${lastQuickAction}` : "";

  const aiMessage = `${topicLine}\n${quick}\n\nUser says: ${msg}`.trim();

  try{
    const reply = await callStudyCoachAPI(aiMessage, tutorHistory, subject, mode);
    finishTyping(reply || "");

    // Update AI memory
    tutorHistory.push({ role:"user", content: msg });
    tutorHistory.push({ role:"assistant", content: reply || "" });
    if(tutorHistory.length > 40) tutorHistory = tutorHistory.slice(-40);

    // If AI handled it, clear offline expected state so it doesn't interfere
    tutorExpected = null;
    tutorExpectedType = null;

  }catch(e){
    console.error("AI failed, falling back to offline:", e);
    finishTyping("I‚Äôm going to use offline mode for this one üíñ");
    handleOffline(msg);
  }
}

// Wire tutor UI (safe bindings to avoid null errors)
on(qExplain, "click", () => { lastQuickAction = "explain"; sendChat("Explain this simply in short steps."); });
on(qExample, "click", () => { lastQuickAction = "example"; sendChat("Give me one simple example."); });
on(qQuiz, "click", () => { lastQuickAction = "quiz"; sendChat("Quick quiz. One question at a time. Keep score out of 5."); });
on(qExplainBack, "click", () => { lastQuickAction = "explain-back"; sendChat("Ask me to explain it back. Then check if I understand."); });
on(qVisual, "click", () => { lastQuickAction = "visual"; sendChat("Show a simple visual using text boxes or number lines."); });

on(sendBtn, "click", () => sendChat());
on(chatInput, "keydown", (e) => { if(e.key === "Enter") sendChat(); });

on(passSupportive, "click", () => setPassMode("supportive"));
on(closeTutor, "click", closeTutorPanel);

on(tutorFab, "click", () => {
  openTutor();
  if(chatLog && !chatLog.childElementCount){
    botSay("Hi Micaela üíñ I‚Äôm your tutor!\nTap ‚ÄòTake Tutor Quiz‚Äô (Maths) or ‚ÄòExplain-back‚Äô (English) on a topic to unlock rewards.");
  }
});

// ===== Visual helpers =====
function numberLineVisual(min, max, step){
  const ticks = [];
  for(let x=min; x<=max; x+=step){ ticks.push(x); }
  return `
  <div style="font-weight:950; margin-bottom:6px;">Number line jumps of ${step}</div>
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    ${ticks.map(t => `<span style="padding:6px 10px;border-radius:999px;border:1px solid rgba(26,18,48,.12);background:rgba(255,255,255,.9);font-weight:950;">${t}</span>`).join("")}
  </div>`;
}

function fractionBarVisual(n, d){
  const parts = Array.from({length:d}).map((_,i)=>{
    const filled = i < n;
    return `<div style="flex:1;height:18px;border-radius:8px;border:1px solid rgba(26,18,48,.12);background:${filled?"rgba(255,79,216,.28)":"rgba(255,255,255,.85)"};"></div>`;
  }).join("");
  return `
  <div style="font-weight:950; margin-bottom:6px;">Fraction bar: ${n}/${d}</div>
  <div style="display:flex; gap:6px;">${parts}</div>`;
}

function fractionCompareVisual(a,b,c,d){
  return `
  <div style="font-weight:950; margin-bottom:8px;">Compare fractions</div>
  <div style="display:grid; gap:10px;">
    <div><div style="font-weight:900;margin-bottom:4px;">${a}/${b}</div>${fractionBarVisual(a,b)}</div>
    <div><div style="font-weight:900;margin-bottom:4px;">${c}/${d}</div>${fractionBarVisual(c,d)}</div>
  </div>`;
}

function placeValueVisual(numStr){
  const labels = ["ones","tens","hundreds","thousands","ten-thousands","hundred-thousands","millions"];
  const digits = String(numStr).split("").reverse();
  const rows = digits.map((dig,i)=>{
    const val = Number(dig) * Math.pow(10,i);
    return `<div style="display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border-radius:14px;border:1px solid rgba(26,18,48,.10);background:rgba(255,255,255,.86);font-weight:900;">
      <span>${dig} in the <strong>${labels[i]||("10^"+i)}</strong> place</span>
      <span>value = <strong>${val.toLocaleString()}</strong></span>
    </div>`;
  }).reverse().join("");
  return `
  <div style="font-weight:950; margin-bottom:8px;">Place value for ${numStr}</div>
  <div style="display:grid; gap:8px;">${rows}</div>`;
}

function clueBubbleVisual(clues, inference){
  return `
  <div style="font-weight:950;margin-bottom:8px;">Clues ‚Üí Inference</div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    ${clues.map(c=>`<span style="padding:8px 10px;border-radius:999px;border:1px solid rgba(26,18,48,.12);background:rgba(255,255,255,.88);font-weight:950;">üß© ${c}</span>`).join("")}
    <span style="font-weight:950;">‚û°Ô∏è</span>
    <span style="padding:10px 12px;border-radius:999px;border:1px solid rgba(26,18,48,.12);background:rgba(255,79,216,.22);font-weight:950;">üí° ${inference}</span>
  </div>`;
}

function highlightCapsVisual(sentence){
  const s = String(sentence);
  const html = s.replace(/\b(i|zimbabwe|april)\b/gi, (m)=>`<span style="background:rgba(0,229,255,.22);padding:0 4px;border-radius:8px;">${m}</span>`);
  return `
  <div style="font-weight:950;margin-bottom:6px;">Capital letters fix</div>
  <div style="padding:10px 12px;border-radius:14px;border:1px solid rgba(26,18,48,.10);background:rgba(255,255,255,.88);font-weight:900;">
    ${html}
  </div>
  <div style="margin-top:8px;font-weight:900;">Now rewrite it with capitals in the right places ‚ú®</div>`;
}

function simpleStepsVisual(steps){
  return `
  <div style="font-weight:950;margin-bottom:8px;">Let‚Äôs learn it step-by-step</div>
  <div style="display:grid; gap:8px;">
    ${steps.map((s,i)=>`<div style="padding:8px 10px;border-radius:14px;border:1px solid rgba(26,18,48,.10);background:rgba(255,255,255,.86);font-weight:900;">${i+1}. ${s}</div>`).join("")}
  </div>`;
}

// ===== Self-tests (run in console) =====
function assert(condition, message){
  if(!condition) throw new Error("Self-test failed: " + message);
}

function runSelfTests(){
  const html = highlightCapsVisual("we visited zimbabwe in april.");
  assert(typeof html === "string" && html.includes("zimbabwe"), "highlightCapsVisual returns expected HTML string");
  assert(/\\b\(i\|zimbabwe\|april\)\\b/.test(highlightCapsVisual.toString()), "highlightCapsVisual uses \\\\b boundaries");

  const expl = OFFLINE_TUTOR["Counting in multiples (input/output tables)"].explain;
  assert(expl.includes("\n"), "Offline tutor explain contains newline characters");

  const expected = OFFLINE_TUTOR["Capital letters (fix capitalisation)"].explainBack;
  const r1 = evaluateExplainBack("We use capitals at the start of a sentence and for names because they are special. Like London.", expected);
  assert(r1.ok === true, "A mode: explain-back passes when core + because + example");
  const r2 = evaluateExplainBack("Capitals are for names.", expected);
  assert(r2.ok === false, "A mode: too short one-liner should fail");

  const ts0 = { conf:"some", practice:true, quizOk:false, explainOk:false };
  assert(calcEarnedForTopic("maths", ts0) === 0, "No money without quiz verification");
  const ts1 = { conf:"some", practice:false, quizOk:true, explainOk:false };
  assert(calcEarnedForTopic("maths", ts1) === REWARD.verified, "Verification awards base amount");
  const ts2 = { conf:"yes", practice:false, quizOk:true, explainOk:false };
  assert(calcEarnedForTopic("maths", ts2) === (REWARD.verified + REWARD.confidentBonus), "Confidence adds bonus after verification");

  render();
  assert(document.querySelectorAll("details.section").length > 0, "render created at least one section");
  assert(on(null, "click", () => {}) === false, "on() returns false for null");
}

try{
  setPassMode("supportive");
  runSelfTests();
}catch(e){
  console.error(e);
}

// Initial render
render();
</script>
