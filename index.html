<script>
/* ================== Small safety helper ================== */
function on(el, event, handler){
  if(!el) return false;
  el.addEventListener(event, handler);
  return true;
}

/* ====== REWARD SETTINGS ====== */
const REWARD = { verified: 1.25, confidentBonus: 0.25 };

/* ====== Confidence Options ====== */
const CONF_OPTIONS = [
  { value: "not", label: "üòü Not confident" },
  { value: "some", label: "üôÇ Getting there" },
  { value: "yes", label: "üòÑ Very confident" }
];

/* ====== DATA (Maths + English) ====== */
const DATA = /* keep your DATA exactly as-is above this script block */ window.DATA || DATA;

/* ====== Storage ====== */
const STORAGE_KEY = "micaela_ks2_checklist_v2_verified";

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return {};
    return JSON.parse(raw);
  }catch(e){
    return {};
  }
}
function saveState(nextState){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(nextState));
}

let state = loadState();

function getTopicState(id){
  return state[id] || { conf:"some", practice:false, quizOk:false, explainOk:false };
}
function setTopicState(id, patch){
  state[id] = { ...getTopicState(id), ...patch };
  saveState(state);
  updateStatsAndProgress();
  render();
}

function isVerifiedFor(tab, ts){
  return tab === "maths" ? Boolean(ts.quizOk) : Boolean(ts.explainOk);
}
function isUnlocked(tab, ts){
  return isVerifiedFor(tab, ts) && ts.conf === "yes";
}
function calcEarnedForTopic(tab, ts){
  if(!isVerifiedFor(tab, ts)) return 0;
  let money = REWARD.verified;
  if(ts.conf === "yes") money += REWARD.confidentBonus;
  return money;
}

/* ====== UI Rendering ====== */
const contentEl = document.getElementById("content");
const tabs = Array.from(document.querySelectorAll(".tab"));
const searchBox = document.getElementById("searchBox");
const clearSearchBtn = document.getElementById("clearSearchBtn");

let activeTab = "maths";
let searchText = "";

tabs.forEach(t => on(t, "click", () => {
  tabs.forEach(x => x.classList.remove("active"));
  t.classList.add("active");
  activeTab = t.dataset.tab;
  render();
}));

on(searchBox, "input", (e) => {
  searchText = ((e.target && e.target.value) || "").trim().toLowerCase();
  render();
});
on(clearSearchBtn, "click", () => {
  searchText = "";
  if(searchBox) searchBox.value = "";
  render();
});

function badge(text){
  const span = document.createElement("span");
  span.className = "badge";
  span.textContent = text;
  return span;
}

function render(){
  if(!contentEl) return;
  const sections = DATA[activeTab];
  contentEl.innerHTML = "";

  sections.forEach(sec => {
    const filteredItems = sec.items.filter(it => {
      if(!searchText) return true;
      const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
      return hay.includes(searchText);
    });
    if(filteredItems.length === 0) return;

    const details = document.createElement("details");
    details.className = "section";
    details.open = !searchText;

    const summary = document.createElement("summary");
    const left = document.createElement("div");
    left.textContent = sec.section;

    const meta = document.createElement("div");
    meta.className = "sectionMeta";
    const secStats = getSectionStats(activeTab, filteredItems);
    meta.appendChild(badge(`üí∞ ¬£${secStats.money.toFixed(2)}`));
    meta.appendChild(badge(`‚úÖ ${secStats.done}/${filteredItems.length}`));

    summary.appendChild(left);
    summary.appendChild(meta);

    const cards = document.createElement("div");
    cards.className = "cards";
    filteredItems.forEach(it => cards.appendChild(renderCard(it)));

    details.appendChild(summary);
    details.appendChild(cards);
    contentEl.appendChild(details);
  });

  updateStatsAndProgress();
}

function checkboxPill(text, checked, onChange){
  const lbl = document.createElement("label");
  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.checked = checked;
  on(cb, "change", () => onChange(cb.checked));
  const span = document.createElement("span");
  span.textContent = text;
  lbl.appendChild(cb);
  lbl.appendChild(span);
  return lbl;
}

function renderCard(item){
  const ts = getTopicState(item.id);

  const card = document.createElement("div");
  card.className = "card";

  const row1 = document.createElement("div");
  row1.className = "row1";

  const topic = document.createElement("div");
  topic.className = "topic";
  topic.textContent = item.topic;

  const code = document.createElement("div");
  code.className = "code";
  code.textContent = item.code || "";

  row1.appendChild(topic);
  row1.appendChild(code);

  const controls = document.createElement("div");
  controls.className = "controls";

  const confWrap = document.createElement("div");
  confWrap.className = "conf";
  const confLabel = document.createElement("label");
  confLabel.textContent = "Confidence:";
  const sel = document.createElement("select");
  CONF_OPTIONS.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    sel.appendChild(o);
  });
  sel.value = ts.conf;
  on(sel, "change", () => setTopicState(item.id, { conf: sel.value }));
  confWrap.appendChild(confLabel);
  confWrap.appendChild(sel);

  const checks = document.createElement("div");
  checks.className = "checks";
  checks.appendChild(checkboxPill("IXL practice done", ts.practice, (val) => setTopicState(item.id, { practice: val })));

  const askBtn = document.createElement("button");
  askBtn.className = "askBtn";
  askBtn.type = "button";
  askBtn.textContent = activeTab === "maths" ? "ü©∑ Take Tutor Quiz" : "ü©∑ Explain-back to Tutor";
  on(askBtn, "click", () => {
    setCurrentTopic(item);
    openTutor();
    if(activeTab === "maths"){
      botSay(`Hi Micaela üíñ\nTo unlock money for ‚Äú${item.topic}‚Äù, pass the Tutor quiz ‚úÖ\nTap Quick Quiz or type: quiz`);
    } else {
      botSay(`Hi Micaela üíñ\nTo unlock money for ‚Äú${item.topic}‚Äù, explain it back in your own words ‚úÖ\nTap Explain-back or type: explain-back`);
    }
  });

  controls.appendChild(confWrap);
  controls.appendChild(checks);
  controls.appendChild(askBtn);

  const pills = document.createElement("div");
  pills.className = "pills";

  const verified = isVerifiedFor(activeTab, ts);
  const needed = activeTab === "maths" ? "Quiz" : "Explain-back";
  const unlocked = isUnlocked(activeTab, ts);

  const vChip = document.createElement("span");
  vChip.className = "chip2";
  vChip.textContent = verified ? `‚úÖ ${needed} verified` : `üîí ${needed} not verified`;

  const cChip = document.createElement("span");
  cChip.className = "chip2";
  cChip.textContent = (ts.conf === "yes") ? "üòÑ Confidence set" : "üôÇ Set confidence to üòÑ";

  const uChip = document.createElement("span");
  uChip.className = "chip2";
  uChip.textContent = unlocked ? "üí∞ Reward unlocked" : "‚è≥ Reward locked";

  pills.appendChild(vChip);
  pills.appendChild(cChip);
  pills.appendChild(uChip);

  const earnedRow = document.createElement("div");
  earnedRow.className = "earnedRow";
  const earnedAmt = calcEarnedForTopic(activeTab, ts);

  const tag1 = document.createElement("span");
  tag1.className = "tagEarned";
  tag1.textContent = `üí∏ Earned: ¬£${earnedAmt.toFixed(2)}`;

  const tag2 = document.createElement("span");
  tag2.className = "tagEarned";
  tag2.textContent = unlocked ? "üåü Unlocked!" : "‚è≥ Keep going";

  earnedRow.appendChild(tag1);
  earnedRow.appendChild(tag2);

  card.appendChild(row1);
  card.appendChild(controls);
  card.appendChild(pills);
  card.appendChild(earnedRow);

  return card;
}

function getAllTopics(){
  const all = [];
  Object.keys(DATA).forEach(k => DATA[k].forEach(sec => sec.items.forEach(it => all.push({ ...it, tab:k }))));
  return all;
}

function getSectionStats(tab, items){
  let money = 0;
  let done = 0;
  items.forEach(it => {
    const ts = getTopicState(it.id);
    money += calcEarnedForTopic(tab, ts);
    if(isUnlocked(tab, ts)) done += 1;
  });
  return { money, done };
}

function updateStatsAndProgress(){
  const all = getAllTopics();
  let totalMoney = 0;
  let topicsDone = 0;

  all.forEach(it => {
    const ts = getTopicState(it.id);
    totalMoney += calcEarnedForTopic(it.tab, ts);
    if(isUnlocked(it.tab, ts)) topicsDone += 1;
  });

  const totalMoneyEl = document.getElementById("totalMoney");
  const topicsDoneEl = document.getElementById("topicsDone");
  if(totalMoneyEl) totalMoneyEl.textContent = `¬£${totalMoney.toFixed(2)}`;
  if(topicsDoneEl) topicsDoneEl.textContent = `${topicsDone}`;

  const visible = [];
  DATA[activeTab].forEach(sec => sec.items.forEach(it => {
    if(!searchText) { visible.push(it); return; }
    const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
    if(hay.includes(searchText)) visible.push(it);
  }));

  const totalVisible = visible.length || 1;
  let doneVisible = 0;
  visible.forEach(it => {
    const ts = getTopicState(it.id);
    if(isUnlocked(activeTab, ts)) doneVisible += 1;
  });

  const pct = Math.round((doneVisible / totalVisible) * 100);
  const fill = document.getElementById("progressFill");
  const pctEl = document.getElementById("progressPct");
  if(fill) fill.style.width = `${pct}%`;
  if(pctEl) pctEl.textContent = `${pct}%`;
}

/* ====== Export / Import / Reset ====== */
const resetBtn = document.getElementById("resetBtn");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");

on(resetBtn, "click", () => {
  if(!confirm("Reset ALL progress? This will clear practice, confidence, and tutor verification.")) return;
  state = {};
  saveState(state);
  render();
});

on(exportBtn, "click", () => {
  const payload = { version: 2, exportedAt: new Date().toISOString(), reward: REWARD, state };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "micaela-checklist-progress.json";
  a.click();
  URL.revokeObjectURL(url);
});

on(importBtn, "click", async () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      if(!parsed || typeof parsed !== "object" || !parsed.state) throw new Error("Invalid file");
      state = parsed.state || {};
      saveState(state);
      render();
      alert("Imported! üéâ");
    }catch(e){
      alert("Sorry ‚Äî that file didn‚Äôt look like a valid export.");
    }
  };
  input.click();
});

/* ===== Tutor Chat (AI first + offline fallback) ===== */
/* KEEP everything from your tutor chat downwards exactly as you pasted,
   EXCEPT replace your self-tests block with the safe one below. */

/* ---------- SAFE SELF TESTS (NEVER BREAK UI) ---------- */
function assert(condition, message){
  if(!condition) throw new Error(message);
}
function runSelfTestsSafe(){
  try{
    const html = highlightCapsVisual("we visited zimbabwe in april.");
    assert(typeof html === "string" && html.includes("zimbabwe"), "highlightCapsVisual should return HTML");

    // ‚úÖ FIXED: check for \b (single slash) in function source
    assert(/\b/.test("x"), "sanity"); // always true, just prevents weird engines
    assert(/\\b\(i\|zimbabwe\|april\)\\b/.test(String(highlightCapsVisual)), "highlightCapsVisual should contain \\b(i|zimbabwe|april)\\b in its source");

    const expl = OFFLINE_TUTOR["Counting in multiples (input/output tables)"]?.explain || "";
    assert(expl.includes("\n"), "Offline tutor explain should contain newline characters");

    render();
    assert(document.querySelectorAll("details.section").length > 0, "render should create at least one section");
    assert(on(null, "click", () => {}) === false, "on() should return false for null");
    console.log("‚úÖ Self-tests passed");
  }catch(e){
    console.warn("‚ö†Ô∏è Self-tests failed (non-fatal):", e.message || e);
  }
}

/* Run tests ONLY if you add ?test=1 to the URL */
try{
  setPassMode?.("supportive");
}catch{}
if(new URLSearchParams(location.search).get("test") === "1"){
  runSelfTestsSafe();
}

/* Initial render (always) */
render();
</script>
