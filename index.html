<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Avoid special characters in <title> for maximum compatibility -->
  <title>Micaela KS2 Power Checklist</title>
  <style>
    :root{
      --bg1:#ff4fd8;
      --bg2:#7b61ff;
      --bg3:#00e5ff;
      --ink:#1a1230;
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.62);
      --stroke: rgba(26,18,48,.12);
      --shadow: 0 14px 40px rgba(18,10,40,.22);
      --shadow2: 0 10px 24px rgba(18,10,40,.18);
      --radius: 22px;
      --radius2: 16px;
      --good:#1bd96a;
      --warn:#ffb020;
      --bad:#ff4a5e;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      min-height:100vh;
      overflow-x:hidden;
    }

    /* sparkle overlay */
    .sparkles{
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.65), transparent 60%),
        radial-gradient(2px 2px at 40% 70%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1.5px 1.5px at 70% 30%, rgba(255,255,255,.50), transparent 60%),
        radial-gradient(1.8px 1.8px at 85% 80%, rgba(255,255,255,.60), transparent 60%),
        radial-gradient(1.2px 1.2px at 25% 85%, rgba(255,255,255,.55), transparent 60%);
      opacity:.75;
      animation: twinkle 5.5s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    @keyframes twinkle{
      0%,100%{opacity:.55; transform:translateY(0)}
      50%{opacity:.9; transform:translateY(-6px)}
    }

    .wrap{max-width:1100px; margin:0 auto; padding:22px 16px 60px}
    header{
      padding:18px 18px 8px;
      border-radius: calc(var(--radius) + 8px);
      background: linear-gradient(135deg, rgba(255,255,255,.72), rgba(255,255,255,.52));
      box-shadow: var(--shadow);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }

    .topline{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand h1{
      margin:0;
      font-size: clamp(20px, 3.6vw, 36px);
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{margin:6px 0 0; opacity:.9}
    .pillrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    .money{
      font-weight:800;
      font-size: 18px;
    }
    .tiny{font-size:12px; opacity:.8}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    button{
      border:0;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:700;
      background: rgba(255,255,255,.84);
      color:var(--ink);
      cursor:pointer;
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      transition: transform .08s ease, filter .15s ease;
    }
    button:hover{filter:brightness(1.03)}
    button:active{transform: translateY(1px)}
    .btn-primary{
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.78));
    }
    .btn-danger{
      background: linear-gradient(135deg, rgba(255,232,236,.95), rgba(255,255,255,.72));
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:14px;
    }

    .panel{
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(255,255,255,.70), rgba(255,255,255,.50));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap:10px;
      padding:14px;
      border-bottom:1px solid rgba(26,18,48,.10);
      flex-wrap:wrap;
    }
    .tab{
      flex: 1 1 160px;
      text-align:center;
      padding:12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight:800;
      border: 1px solid rgba(26,18,48,.12);
      background: rgba(255,255,255,.72);
      transition: transform .08s ease, filter .15s ease;
      user-select:none;
    }
    .tab:hover{filter:brightness(1.03)}
    .tab.active{
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      transform: translateY(-1px);
    }

    .toolbar{
      display:flex;
      gap:10px;
      padding:14px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .search{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      flex:1 1 340px;
    }
    input[type="search"]{
      width:min(520px, 100%);
      border-radius: 16px;
      padding:12px 14px;
      border:1px solid rgba(26,18,48,.12);
      outline:none;
      background: rgba(255,255,255,.85);
      font-weight:650;
    }

    .progressWrap{
      flex: 1 1 260px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .bar{
      width:min(360px, 100%);
      height:12px;
      border-radius:999px;
      background: rgba(26,18,48,.10);
      overflow:hidden;
      border:1px solid rgba(26,18,48,.10);
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #00ffcc, #7b61ff, #ff4fd8);
      transition: width .25s ease;
    }
    .pct{font-weight:900}

    .sections{padding: 0 14px 14px}
    details.section{
      border:1px solid rgba(26,18,48,.10);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.62);
      margin-bottom: 12px;
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
    }
    summary::-webkit-details-marker{display:none}
    .sectionMeta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      font-weight:800;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(26,18,48,.10);
      font-size:12px;
    }
    .cards{
      padding: 10px 12px 14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
    }
    .card{
      grid-column: span 12;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(26,18,48,.10);
      box-shadow: 0 10px 20px rgba(18,10,40,.10);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    @media (min-width: 720px){
      .card{grid-column: span 6;}
    }
    @media (min-width: 980px){
      .card{grid-column: span 4;}
    }

    .row1{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .topic{
      font-weight:950;
      line-height:1.2;
    }
    .code{
      font-size:12px;
      opacity:.8;
      font-weight:800;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px dashed rgba(26,18,48,.20);
      background: rgba(255,255,255,.55);
      white-space:nowrap;
    }
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    .conf{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .conf label{
      font-size:12px;
      font-weight:900;
      opacity:.85;
    }
    select{
      border-radius: 14px;
      padding:10px 10px;
      border:1px solid rgba(26,18,48,.12);
      background: rgba(255,255,255,.9);
      font-weight:800;
      outline:none;
    }
    .checks{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-weight:800;
    }
    .checks label{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(26,18,48,.10);
      border-radius: 999px;
      padding:8px 10px;
      user-select:none;
    }
    input[type="checkbox"]{width:18px; height:18px}

    .earnedRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-weight:900;
    }
    .earned{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .tagEarned{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(26,18,48,.10);
      background: rgba(255,255,255,.85);
      font-size:12px;
      font-weight:950;
    }

    .note{
      padding: 0 14px 14px;
      font-size: 12px;
      opacity:.85;
      line-height:1.4;
    }

    .footer{
      margin-top:12px;
      padding:14px 18px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.58);
      border:1px solid rgba(26,18,48,.10);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      font-size:12px;
      line-height:1.45;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:800;
      background: rgba(255,255,255,.8);
      border:1px solid rgba(26,18,48,.12);
      border-radius: 8px;
      padding:2px 6px;
    }

    /* === Tutor Chat (Katseye pink vibes) === */
    .tutorFab{
      position:fixed;
      right:18px;
      bottom:18px;
      z-index:50;
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      border-radius: 999px;
      border:1px solid rgba(26,18,48,.12);
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
      font-weight:950;
    }
    .tutorFab small{opacity:.8; font-weight:800}

    .tutorPanel{
      position:fixed;
      right:18px;
      bottom:86px;
      width:min(420px, calc(100vw - 36px));
      height:min(620px, calc(100vh - 120px));
      z-index:60;
      border-radius: 26px;
      background: linear-gradient(135deg, rgba(255,255,255,.80), rgba(255,255,255,.58));
      border:1px solid rgba(26,18,48,.12);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      display:none;
    }
    .tutorPanel.open{display:flex; flex-direction:column;}

    .tutorHead{
      padding:12px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(26,18,48,.10);
      background: linear-gradient(135deg, rgba(255,79,216,.18), rgba(123,97,255,.14), rgba(0,229,255,.10));
    }
    .tutorTitle{font-weight:950; line-height:1.15}
    .tutorSub{font-size:12px; opacity:.85; margin-top:4px}

    .tutorControls{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(26,18,48,.12);
      background: rgba(255,255,255,.82);
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .chip.active{background: rgba(255,255,255,.95)}

    .tutorBody{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      height:100%;
    }
    .chatLog{
      flex:1;
      overflow:auto;
      padding:8px;
      border-radius: 18px;
      border:1px solid rgba(26,18,48,.10);
      background: rgba(255,255,255,.70);
    }
    .msg{margin:8px 0; display:flex;}
    .msg .bubble{
      max-width: 88%;
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid rgba(26,18,48,.10);
      box-shadow: 0 8px 18px rgba(18,10,40,.08);
      line-height:1.35;
      font-weight:750;
      font-size:13px;
      white-space:pre-wrap;
    }
    .msg.user{justify-content:flex-end;}
    .msg.user .bubble{background: rgba(255,79,216,.18)}
    .msg.bot .bubble{background: rgba(123,97,255,.14)}

    .quickRow{display:flex; gap:8px; flex-wrap:wrap}

    .tutorInput{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .tutorInput input{
      flex:1;
      border-radius: 16px;
      padding:12px 12px;
      border:1px solid rgba(26,18,48,.12);
      background: rgba(255,255,255,.92);
      font-weight:850;
      outline:none;
    }
    .sendBtn{
      border-radius: 16px;
      padding:12px 12px;
      border:1px solid rgba(26,18,48,.12);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow2);
      font-weight:950;
      cursor:pointer;
    }

    .miniVisual{
      margin-top:8px;
      border-radius: 16px;
      border:1px solid rgba(26,18,48,.10);
      background: rgba(255,255,255,.80);
      padding:10px;
    }

    .askBtn{
      border-radius: 999px;
      padding:8px 10px;
      border:1px solid rgba(26,18,48,.12);
      background: rgba(255,255,255,.90);
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(18,10,40,.08);
    }

    @media (max-width: 520px){
      .tutorPanel{right:10px; bottom:86px; width: calc(100vw - 20px)}
      .tutorFab{right:10px; bottom:12px}
    }
  </style>
</head>

<body>
  <div class="sparkles" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="topline">
        <div class="brand">
          <h1>‚ú® Micaela‚Äôs KS2 Power Checklist ‚ú®</h1>
          <p>Pink, sparkly, and super clear ‚Äî tick topics, set confidence, and earn rewards üíñ</p>
        </div>

        <div class="pillrow">
          <div class="pill" title="Total money earned from completed work">
            <div>üí∞</div>
            <div>
              <div class="tiny">Total earned</div>
              <div class="money" id="totalMoney">¬£0.00</div>
            </div>
          </div>
          <div class="pill" title="Topics completed (practice + test)">
            <div>‚úÖ</div>
            <div>
              <div class="tiny">Topics completed</div>
              <div class="money" id="topicsDone">0</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" id="exportBtn">Export progress</button>
          <button class="btn-primary" id="importBtn">Import progress</button>
          <button class="btn-danger" id="resetBtn">Reset</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <div class="panel">
        <div class="tabs">
          <div class="tab active" data-tab="maths">üìò Maths</div>
          <div class="tab" data-tab="english">üìó English</div>
        </div>

        <div class="toolbar">
          <div class="search">
            <input id="searchBox" type="search" placeholder="Search topics‚Ä¶ e.g. fractions, commas, inference" />
            <button id="clearSearchBtn">Clear</button>
          </div>

          <div class="progressWrap">
            <div class="bar" aria-label="Overall progress">
              <div id="progressFill"></div>
            </div>
            <div class="pct" id="progressPct">0%</div>
          </div>
        </div>

        <div class="sections" id="content"></div>

        <div class="note">
          Reward rules are editable in the code (look for <span class="kbd">REWARD</span>). Everything saves automatically on this device.
        </div>
      </div>

      <!-- Tutor Chat UI -->
      <div class="tutorPanel" id="tutorPanel" role="dialog" aria-label="Micaela Tutor Chat">
        <div class="tutorHead">
          <div>
            <div class="tutorTitle">üíñ Tutor Chat</div>
            <div class="tutorSub" id="tutorTopic">Topic: (pick a topic or tap ‚ÄúAsk Tutor‚Äù)</div>
          </div>
          <div class="tutorControls">
            <div class="chip active" id="modeOffline">Offline</div>
            <div class="chip" id="modeAI">AI</div>
            <div class="chip" id="closeTutor">‚úï</div>
          </div>
        </div>
        <div class="tutorBody">
          <div class="quickRow">
            <div class="chip" id="qExplain">Explain</div>
            <div class="chip" id="qExample">Example</div>
            <div class="chip" id="qQuiz">Quick Quiz</div>
            <div class="chip" id="qVisual">Show Visual</div>
          </div>
          <div class="chatLog" id="chatLog" aria-live="polite"></div>
          <div class="tutorInput">
            <input id="chatInput" placeholder="Ask me anything about this topic‚Ä¶" />
            <button class="sendBtn" id="sendBtn">Send ‚ú®</button>
          </div>
          <div class="note" style="padding:0; margin-top:-2px;">
            <strong>Offline</strong> = safe built-in tutor. <strong>AI</strong> = needs a secure backend endpoint (so your API key stays private).
          </div>
        </div>
      </div>
      <div class="tutorFab" id="tutorFab">ü©∑ Tutor <small id="fabHint">(offline)</small></div>

      <div class="footer">
        <strong>How money works (default):</strong>
        <ul>
          <li>Practice done = <strong>¬£0.50</strong></li>
          <li>Test passed = <strong>¬£0.50</strong></li>
          <li>Confidence ‚ÄúüòÑ Very confident‚Äù bonus = <strong>¬£0.25</strong></li>
          <li>Topic fully completed (practice + test) bonus = <strong>¬£0.25</strong></li>
        </ul>
        Max per topic = <strong>¬£1.50</strong>. You can change this anytime.
      </div>
    </div>
  </div>

<script>
/**
 * Fixes applied:
 * 1) Removed special characters from <title> for compatibility.
 * 2) Replaced invalid JS string literals that contained raw newlines with template literals / \n.
 * 3) Fixed accidental control characters in a regex by using \b word boundaries.
 */

// ====== REWARD SETTINGS (edit these if you want) ======
const REWARD = {
  practice: 0.50,
  test: 0.50,
  confidentBonus: 0.25,       // when confidence is üòÑ
  completeBonus: 0.25         // when practice + test are both checked
};

// ====== Confidence Options ======
const CONF_OPTIONS = [
  { value: "not", label: "üòü Not confident" },
  { value: "some", label: "üôÇ Getting there" },
  { value: "yes", label: "üòÑ Very confident" }
];

// ====== DATA (Maths + English) ======
const DATA = {
  maths: [
    {
      section: "Number & Place Value",
      items: [
        { id:"m_N1", topic:"Counting in multiples (input/output tables)", code:"N1 ‚Ä¢ 6V2" },
        { id:"m_N2", topic:"Ten more or less / compare & order numbers to 10 million", code:"N2 ‚Ä¢ BYZ/9MH" },
        { id:"m_N2b", topic:"Write numbers up to 10 million in words", code:"N2 ‚Ä¢ 84X" },
        { id:"m_N3", topic:"Expanded form & Roman numerals", code:"N3 ‚Ä¢ ATH/BAK" },
        { id:"m_N4", topic:"Rounding (up to millions place)", code:"N4 ‚Ä¢ X65" },
        { id:"m_N5", topic:"Negative numbers (integers)", code:"N5 ‚Ä¢ 7SS" },
        { id:"m_N6", topic:"Place value word problems", code:"N6 ‚Ä¢ DGS" }
      ]
    },
    {
      section: "Calculations (Add/Subtract/Multiply/Divide)",
      items: [
        { id:"m_C1", topic:"Mental add/subtract with zeros", code:"C1 ‚Ä¢ YCD" },
        { id:"m_C2a", topic:"Add numbers up to six digits", code:"C2 ‚Ä¢ KNF" },
        { id:"m_C2b", topic:"Subtract numbers up to six digits", code:"C2 ‚Ä¢ FHZ" },
        { id:"m_C3", topic:"Estimate & check answers (reasonable answers)", code:"C3 ‚Ä¢ 49F" },
        { id:"m_C4", topic:"Multi-step add/subtract word problems", code:"C4 ‚Ä¢ 6NM" },
        { id:"m_C5", topic:"Factors, multiples, primes (incl HCF/LCM)", code:"C5 ‚Ä¢ Q9A/74F/WNB" },
        { id:"m_C6", topic:"Multiply/divide mentally with zeros", code:"C6 ‚Ä¢ 9BT" },
        { id:"m_C7a", topic:"Multiply 2-digit by 3/4-digit", code:"C7 ‚Ä¢ 5G6" },
        { id:"m_C7b", topic:"Divide 4-digit by 2-digit (and word problems)", code:"C7 ‚Ä¢ BY7/48X" },
        { id:"m_C8", topic:"Multi-step problems using all operations", code:"C8 ‚Ä¢ JFJ" },
        { id:"m_C9", topic:"Order of operations (brackets/square brackets)", code:"C9 ‚Ä¢ 9PZ" }
      ]
    },
    {
      section: "Fractions, Decimals & Percentages",
      items: [
        { id:"m_F2", topic:"Equivalent fractions & simplest form", code:"F2 ‚Ä¢ MP2/FXV" },
        { id:"m_F3", topic:"Compare & order fractions", code:"F3 ‚Ä¢ BF9" },
        { id:"m_F4", topic:"Add/subtract fractions with different denominators", code:"F4 ‚Ä¢ UW7" },
        { id:"m_F5", topic:"Multiply fractions / divide fractions by whole numbers", code:"F5 ‚Ä¢ YB2/A2R" },
        { id:"m_F6", topic:"Convert fractions to decimals", code:"F6 ‚Ä¢ 4K2" },
        { id:"m_F7", topic:"Round decimals", code:"F7 ‚Ä¢ LXK" },
        { id:"m_F8", topic:"Compare & order decimals to thousandths", code:"F8 ‚Ä¢ U6K/ASD" },
        { id:"m_F9", topic:"Multiply/divide decimals (10/100/1000 etc.)", code:"F9 ‚Ä¢ WJ8/PZB/CNS/9DZ" },
        { id:"m_F10", topic:"Decimal word problems & rounding", code:"F10 ‚Ä¢ YTU/LKL" },
        { id:"m_F11", topic:"Convert between percents, fractions & decimals (word problems)", code:"F11 ‚Ä¢ TND" },
        { id:"m_F12", topic:"Percentage problems & comparisons", code:"F12 ‚Ä¢ CGZ/FHN" }
      ]
    },
    {
      section: "Ratio, Proportion & Algebra",
      items: [
        { id:"m_R1", topic:"Ratios and rates word problems", code:"R1 ‚Ä¢ EKA" },
        { id:"m_R2", topic:"Percent of a number & comparing percents", code:"R2 ‚Ä¢ QLE/49P" },
        { id:"m_R3", topic:"Scale drawings / scale factors word problems", code:"R3 ‚Ä¢ R99" },
        { id:"m_R4", topic:"Fractions of a number & multiplicative comparison", code:"R4 ‚Ä¢ APR/ZML" },
        { id:"m_A1", topic:"One-step equations from diagrams", code:"A1 ‚Ä¢ Z7D" },
        { id:"m_A2", topic:"Write variable expressions (word problems)", code:"A2 ‚Ä¢ ZU2" },
        { id:"m_A3", topic:"Number sequences (use a rule)", code:"A3 ‚Ä¢ PWX" },
        { id:"m_A4", topic:"Does (x, y) satisfy an equation?", code:"A4 ‚Ä¢ UHF" },
        { id:"m_A5", topic:"Two-variable tables / relationships", code:"A5 ‚Ä¢ BKG" }
      ]
    },
    {
      section: "Measurement",
      items: [
        { id:"m_M5", topic:"Convert metric units", code:"M5 ‚Ä¢ XHY" },
        { id:"m_M2", topic:"Measure using a ruler & choose appropriate units", code:"M2 ‚Ä¢ EWK/MKW/Z6G/D98" },
        { id:"m_M3", topic:"Money (count coins/notes)", code:"M3 ‚Ä¢ XZZ" },
        { id:"m_M4", topic:"Time conversions + start/end time problems", code:"M4 ‚Ä¢ 6BE/NWK" },
        { id:"m_M6", topic:"Convert miles and kilometres", code:"M6 ‚Ä¢ EMG" },
        { id:"m_M7", topic:"Area & perimeter (incl triangles/parallelograms)", code:"M7 ‚Ä¢ SCN/9GQ" },
        { id:"m_M8", topic:"Volume of cubes/cuboids", code:"M8 ‚Ä¢ M7H" },
        { id:"m_M9", topic:"Multi-step measurement conversion problems", code:"M9 ‚Ä¢ MDK" }
      ]
    },
    {
      section: "Geometry & Statistics",
      items: [
        { id:"m_G1", topic:"Properties of polygons", code:"G1 ‚Ä¢ ZQC" },
        { id:"m_G2", topic:"Classify triangles and quadrilaterals", code:"G2 ‚Ä¢ BT2/MJ2" },
        { id:"m_G3", topic:"Draw quadrilaterals & 3D nets", code:"G3 ‚Ä¢ BMN/LB8" },
        { id:"m_G4", topic:"Measure/draw angles + missing angles", code:"G4 ‚Ä¢ X8P/L2F/VLL/59J" },
        { id:"m_G5", topic:"Parts of a circle", code:"G5 ‚Ä¢ PGE" },
        { id:"m_P2", topic:"Translations & reflections on grids", code:"P2 ‚Ä¢ U6P/YR8" },
        { id:"m_P3", topic:"Coordinate plane & quadrants", code:"P3 ‚Ä¢ B45/MZM" },
        { id:"m_S1", topic:"Interpret pie charts & create line graphs", code:"S1 ‚Ä¢ DDW/YJT" },
        { id:"m_S2", topic:"Interpret pictograms/bar/line graphs (multi-step)", code:"S2 ‚Ä¢ KZS/9AG/JUJ" },
        { id:"m_S3", topic:"Mean average from charts", code:"S3 ‚Ä¢ 7DZ" }
      ]
    }
  ],

  english: [
    {
      section: "Reading (SATs skills)",
      items: [
        { id:"e_2a", topic:"Meaning of words in context", code:"2a ‚Ä¢ LZY" },
        { id:"e_2b_lit", topic:"Retrieve/record key details (literary texts)", code:"2b ‚Ä¢ XXT/S9R" },
        { id:"e_2b_info", topic:"Retrieve/record key details (informational texts)", code:"2b ‚Ä¢ J88/GNY" },
        { id:"e_2c", topic:"Summarise main ideas & order events", code:"2c ‚Ä¢ UHG/YL5" },
        { id:"e_2d", topic:"Inferences + evidence (supporting details)", code:"2d ‚Ä¢ 2ZT/S6H/7YR/AVC" },
        { id:"e_2e", topic:"Predict what might happen (stated + implied)", code:"2e ‚Ä¢ 77K" },
        { id:"e_2f", topic:"Text structure (story elements/cause-effect/problem-solution)", code:"2f ‚Ä¢ 4Q6/7EF/GWK/DR5/Q9H" },
        { id:"e_2g", topic:"Word choice & meaning (connotation/sensory/figurative language)", code:"2g ‚Ä¢ QT6/FKF/TNH/2NX" },
        { id:"e_2h", topic:"Compare within a text (viewpoints/characters/info)", code:"2h ‚Ä¢ 29Q/ZK9/UYK" }
      ]
    },
    {
      section: "Grammar: Word Classes",
      items: [
        { id:"g_nouns", topic:"Nouns (incl abstract, possessives)", code:"G1.1 ‚Ä¢ 8XL/EXU/NH9" },
        { id:"g_verbs", topic:"Verbs (action, helping, modal meaning)", code:"G1.2 ‚Ä¢ PLX/Y78/5QD" },
        { id:"g_adj", topic:"Adjectives (identify + compare)", code:"G1.3 ‚Ä¢ YJ5/ANG" },
        { id:"g_conj", topic:"Conjunctions (coordinating/subordinating)", code:"G1.4 ‚Ä¢ 6ES/Q83" },
        { id:"g_pron", topic:"Pronouns (subject/object)", code:"G1.5 ‚Ä¢ M67/QD8" },
        { id:"g_adv", topic:"Adverbs (identify + compare)", code:"G1.6 ‚Ä¢ CWX/BVY" },
        { id:"g_prep", topic:"Prepositions", code:"G1.7 ‚Ä¢ 7C7" },
        { id:"g_det", topic:"Determiners (articles)", code:"G1.8 ‚Ä¢ M5L" },
        { id:"g_subobj", topic:"Subject and object (complete subject)", code:"G1.9 ‚Ä¢ ZWS" }
      ]
    },
    {
      section: "Sentence Types & Clauses",
      items: [
        { id:"g_senttypes", topic:"Statements/questions/commands/exclamations", code:"G2 ‚Ä¢ PWA" },
        { id:"g_clauses", topic:"Dependent vs independent clauses", code:"G3.1 ‚Ä¢ YDH" },
        { id:"g_nounphr", topic:"Noun phrases (adjective order, more/most)", code:"G3.2 ‚Ä¢ BRZ/SL8" },
        { id:"g_coord", topic:"Co-ordinating conjunctions (use correctly)", code:"G3.3 ‚Ä¢ CPS" },
        { id:"g_subord", topic:"Subordinating conjunctions + subordinate clauses", code:"G3.4 ‚Ä¢ FZC" }
      ]
    },
    {
      section: "Tense & Consistency",
      items: [
        { id:"g_tense", topic:"Tense consistency (fix tense shifts)", code:"G4.2 ‚Ä¢ 9MP" }
      ]
    },
    {
      section: "Punctuation",
      items: [
        { id:"p_caps", topic:"Capital letters (fix capitalisation)", code:"G5.1 ‚Ä¢ H7T" },
        { id:"p_endmarks", topic:"Full stops, question marks, exclamation marks", code:"G5.2‚Äì5.4 ‚Ä¢ PWA" },
        { id:"p_quotes", topic:"Inverted commas (titles/formatting)", code:"G5.7 ‚Ä¢ RJZ" },
        { id:"p_apost", topic:"Apostrophes: contractions + possessives", code:"G5.8 ‚Ä¢ SK5/9ME/SP7" },
        { id:"p_dashes", topic:"Dashes", code:"G5.12 ‚Ä¢ URX" }
      ]
    },
    {
      section: "Vocabulary & Spelling",
      items: [
        { id:"v_syn", topic:"Synonyms & antonyms in context", code:"G6.1 ‚Ä¢ WVB/2TL" },
        { id:"v_pref", topic:"Prefixes (re-, mis-, un-/dis-/in-/im-/non-)", code:"G6.2 ‚Ä¢ KUW/UMV/A5X" },
        { id:"v_suf", topic:"Suffixes (-ful, -less) + plurals review", code:"G6.3 ‚Ä¢ 32W/9ML/FKY" },
        { id:"v_roots", topic:"Word families (Greek/Latin roots)", code:"G6.4 ‚Ä¢ 9Z5/8A6" },
        { id:"s_excepts", topic:"Common exception words (patterns like -ild/-ind etc.)", code:"S37 ‚Ä¢ A9C" },
        { id:"s_diph", topic:"Diphthongs (oi/oy/ou/ow)", code:"S40 ‚Ä¢ LT9" },
        { id:"s_digraph", topic:"Digraphs (ch/sh/th)", code:"S48‚Äì49 ‚Ä¢ LN7" },
        { id:"s_silent", topic:"Silent letters", code:"S60 ‚Ä¢ FYB" },
        { id:"s_homo", topic:"Homophones", code:"S61 ‚Ä¢ 7QU" }
      ]
    }
  ]
};

// ====== Storage ======
const STORAGE_KEY = "micaela_ks2_checklist_v1";

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return {};
    return JSON.parse(raw);
  }catch(e){
    return {};
  }
}
function saveState(st){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
}

let state = loadState();
// state structure: { [topicId]: { conf, practice, test } }

function getTopicState(id){
  return state[id] || { conf:"some", practice:false, test:false };
}
function setTopicState(id, patch){
  state[id] = { ...getTopicState(id), ...patch };
  saveState(state);
  updateStatsAndProgress();
}

function calcEarnedForTopic(ts){
  let money = 0;
  if(ts.practice) money += REWARD.practice;
  if(ts.test) money += REWARD.test;
  if(ts.conf === "yes") money += REWARD.confidentBonus;
  if(ts.practice && ts.test) money += REWARD.completeBonus;
  return money;
}

function isTopicComplete(ts){
  return Boolean(ts.practice && ts.test);
}

// ====== UI Rendering ======
const contentEl = document.getElementById("content");
const tabs = Array.from(document.querySelectorAll(".tab"));
const searchBox = document.getElementById("searchBox");
const clearSearchBtn = document.getElementById("clearSearchBtn");

let activeTab = "maths";
let searchText = "";

tabs.forEach(t => t.addEventListener("click", () => {
  tabs.forEach(x => x.classList.remove("active"));
  t.classList.add("active");
  activeTab = t.dataset.tab;
  render();
}));

searchBox.addEventListener("input", (e) => {
  searchText = (e.target.value || "").trim().toLowerCase();
  render();
});
clearSearchBtn.addEventListener("click", () => {
  searchText = "";
  searchBox.value = "";
  render();
});

function render(){
  const sections = DATA[activeTab];

  contentEl.innerHTML = "";
  sections.forEach(sec => {
    const filteredItems = sec.items.filter(it => {
      if(!searchText) return true;
      const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
      return hay.includes(searchText);
    });

    if(filteredItems.length === 0) return;

    const details = document.createElement("details");
    details.className = "section";
    details.open = !searchText;

    const summary = document.createElement("summary");

    const left = document.createElement("div");
    left.textContent = sec.section;

    const meta = document.createElement("div");
    meta.className = "sectionMeta";

    const secStats = getSectionStats(filteredItems);
    const b1 = badge(`üí∞ ¬£${secStats.money.toFixed(2)}`);
    const b2 = badge(`‚úÖ ${secStats.done}/${filteredItems.length}`);
    meta.appendChild(b1);
    meta.appendChild(b2);

    summary.appendChild(left);
    summary.appendChild(meta);

    const cards = document.createElement("div");
    cards.className = "cards";

    filteredItems.forEach(it => cards.appendChild(renderCard(it)));

    details.appendChild(summary);
    details.appendChild(cards);
    contentEl.appendChild(details);
  });

  updateStatsAndProgress();
}

function badge(text){
  const span = document.createElement("span");
  span.className = "badge";
  span.textContent = text;
  return span;
}

function renderCard(item){
  const ts = getTopicState(item.id);

  const card = document.createElement("div");
  card.className = "card";

  const row1 = document.createElement("div");
  row1.className = "row1";

  const topic = document.createElement("div");
  topic.className = "topic";
  topic.textContent = item.topic;

  const code = document.createElement("div");
  code.className = "code";
  code.textContent = item.code || "";

  row1.appendChild(topic);
  row1.appendChild(code);

  const controls = document.createElement("div");
  controls.className = "controls";

  // Ask Tutor button (opens chat with this topic selected)
  const askBtn = document.createElement("button");
  askBtn.className = "askBtn";
  askBtn.type = "button";
  askBtn.textContent = "ü©∑ Ask Tutor";
  askBtn.addEventListener("click", () => {
    setCurrentTopic(item);
    openTutor();
    botSay(`Hi Micaela üíñ\nWant me to explain ‚Äú${item.topic}‚Äù or do a quick quiz?`);
  });

  // confidence
  const confWrap = document.createElement("div");
  confWrap.className = "conf";
  const confLabel = document.createElement("label");
  confLabel.textContent = "Confidence:";
  const sel = document.createElement("select");
  CONF_OPTIONS.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    sel.appendChild(o);
  });
  sel.value = ts.conf;
  sel.addEventListener("change", () => setTopicState(item.id, { conf: sel.value }));

  confWrap.appendChild(confLabel);
  confWrap.appendChild(sel);

  // checkboxes
  const checks = document.createElement("div");
  checks.className = "checks";

  const practiceLbl = checkboxPill("Practice done", ts.practice, (val) => setTopicState(item.id, { practice: val }));
  const testLbl = checkboxPill("Test passed", ts.test, (val) => setTopicState(item.id, { test: val }));

  checks.appendChild(practiceLbl);
  checks.appendChild(testLbl);

  controls.appendChild(confWrap);
  controls.appendChild(checks);
  controls.appendChild(askBtn);

  const earnedRow = document.createElement("div");
  earnedRow.className = "earnedRow";

  const earned = document.createElement("div");
  earned.className = "earned";

  const earnedAmt = calcEarnedForTopic(ts);
  const done = isTopicComplete(ts);

  const tag1 = document.createElement("span");
  tag1.className = "tagEarned";
  tag1.textContent = `üí∏ Earned: ¬£${earnedAmt.toFixed(2)}`;

  const tag2 = document.createElement("span");
  tag2.className = "tagEarned";
  tag2.textContent = done ? "üåü Completed!" : "‚è≥ In progress";

  earned.appendChild(tag1);
  earned.appendChild(tag2);
  earnedRow.appendChild(earned);

  card.appendChild(row1);
  card.appendChild(controls);
  card.appendChild(earnedRow);

  return card;
}

function checkboxPill(text, checked, onChange){
  const lbl = document.createElement("label");
  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.checked = checked;
  cb.addEventListener("change", () => onChange(cb.checked));
  const span = document.createElement("span");
  span.textContent = text;
  lbl.appendChild(cb);
  lbl.appendChild(span);
  return lbl;
}

function getAllTopics(){
  const all = [];
  Object.keys(DATA).forEach(k => {
    DATA[k].forEach(sec => sec.items.forEach(it => all.push(it)));
  });
  return all;
}

function getSectionStats(items){
  let money = 0;
  let done = 0;
  items.forEach(it => {
    const ts = getTopicState(it.id);
    money += calcEarnedForTopic(ts);
    if(isTopicComplete(ts)) done += 1;
  });
  return { money, done };
}

function updateStatsAndProgress(){
  const visibleItems = [];
  DATA[activeTab].forEach(sec => {
    sec.items.forEach(it => {
      if(!searchText) { visibleItems.push(it); return; }
      const hay = (it.topic + " " + (it.code||"") + " " + sec.section).toLowerCase();
      if(hay.includes(searchText)) visibleItems.push(it);
    });
  });

  const all = getAllTopics();
  let totalMoney = 0;
  let topicsDone = 0;
  all.forEach(it => {
    const ts = getTopicState(it.id);
    totalMoney += calcEarnedForTopic(ts);
    if(isTopicComplete(ts)) topicsDone += 1;
  });

  document.getElementById("totalMoney").textContent = `¬£${totalMoney.toFixed(2)}`;
  document.getElementById("topicsDone").textContent = `${topicsDone}`;

  const totalVisible = visibleItems.length || 1;
  let doneVisible = 0;
  visibleItems.forEach(it => {
    const ts = getTopicState(it.id);
    if(isTopicComplete(ts)) doneVisible += 1;
  });

  const pct = Math.round((doneVisible / totalVisible) * 100);
  document.getElementById("progressFill").style.width = `${pct}%`;
  document.getElementById("progressPct").textContent = `${pct}%`;
}

// ====== Export / Import / Reset ======
document.getElementById("resetBtn").addEventListener("click", () => {
  if(!confirm("Reset ALL progress? This will clear ticks, confidence, and money totals.")) return;
  state = {};
  saveState(state);
  render();
});

document.getElementById("exportBtn").addEventListener("click", () => {
  const payload = {
    version: 1,
    exportedAt: new Date().toISOString(),
    reward: REWARD,
    state
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "micaela-checklist-progress.json";
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("importBtn").addEventListener("click", async () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      if(!parsed || typeof parsed !== "object" || !parsed.state) throw new Error("Invalid file");
      state = parsed.state || {};
      saveState(state);
      render();
      alert("Imported! üéâ");
    }catch(e){
      alert("Sorry ‚Äî that file didn‚Äôt look like a valid export.");
    }
  };
  input.click();
});

// ===== Tutor Chat (Offline + Optional AI) =====
const tutorPanel = document.getElementById("tutorPanel");
const tutorFab = document.getElementById("tutorFab");
const tutorTopicEl = document.getElementById("tutorTopic");
const chatLog = document.getElementById("chatLog");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const modeOffline = document.getElementById("modeOffline");
const modeAI = document.getElementById("modeAI");
const closeTutor = document.getElementById("closeTutor");
const fabHint = document.getElementById("fabHint");

const qExplain = document.getElementById("qExplain");
const qExample = document.getElementById("qExample");
const qQuiz = document.getElementById("qQuiz");
const qVisual = document.getElementById("qVisual");

let tutorMode = "offline"; // "offline" | "ai"
let currentTopic = null; // {id, topic, code}

// Super-safe offline mini knowledge base (expand anytime)
const OFFLINE_TUTOR = {
  // Maths
  "Counting in multiples (input/output tables)": {
    explain: `Counting in multiples means jumping by the same number each time (like +2, +5, +10).\nInput/output tables show a rule that turns an input into an output.`,
    example: `If the rule is √ó3, then:\nInput 2 ‚Üí Output 6\nInput 4 ‚Üí Output 12\nTry: Input 5 ‚Üí Output ?`,
    quiz: { q:"Rule is +7. If input is 9, what is output?", a:"16" },
    visual: () => numberLineVisual(0, 35, 7)
  },
  "Equivalent fractions & simplest form": {
    explain: `Equivalent fractions are the same value written in different ways.\nYou can multiply or divide the top and bottom by the SAME number.`,
    example: `1/2 is the same as 2/4 and 3/6.\nBecause we multiplied top & bottom by 2 or 3.`,
    quiz: { q:"Is 3/6 equivalent to 1/2? (yes/no)", a:"yes" },
    visual: () => fractionBarVisual(1,2)
  },
  "Compare & order fractions": {
    explain: `To compare fractions:\n‚Ä¢ If denominators match, bigger numerator is bigger.\n‚Ä¢ If not, convert to a common denominator or use fraction bars.`,
    example: `Compare 1/3 and 1/2.\nHalf is bigger because 1 out of 2 is larger than 1 out of 3.`,
    quiz: { q:"Which is bigger: 3/4 or 2/3?", a:"3/4" },
    visual: () => fractionCompareVisual(3,4,2,3)
  },
  "Place value word problems": {
    explain: `Place value tells you what each digit is worth (ones, tens, hundreds, thousands‚Ä¶).\nWord problems often ask you to use that to compare or calculate.`,
    example: "In 54,321 the 5 is 50,000 and the 3 is 300.",
    quiz: { q:"In 7,205 what is the value of the 2?", a:"200" },
    visual: () => placeValueVisual("7205")
  },

  // English
  "Inferences + evidence (supporting details)": {
    explain: `Inference means you use clues + what you know to figure something out that isn‚Äôt said directly.\nEvidence is the words from the text that prove your idea.`,
    example: `Text: ‚ÄòSam pulled on his coat and shivered.‚Äô\nInference: It is cold.\nEvidence: ‚Äòpulled on his coat‚Äô + ‚Äòshivered‚Äô.`,
    quiz: { q:"Text: ‚ÄòThe ground was wet and umbrellas opened.‚Äô What‚Äôs a good inference?", a:"It is raining" },
    visual: () => clueBubbleVisual(["wet ground","umbrellas"], "It is raining")
  },
  "Capital letters (fix capitalisation)": {
    explain: `Use capital letters for:\n‚Ä¢ The start of a sentence\n‚Ä¢ Names (people/places)\n‚Ä¢ Days/months\n‚Ä¢ ‚ÄòI‚Äô\n‚Ä¢ Titles (sometimes)`,
    example: `Wrong: i went to london on monday.\nRight: I went to London on Monday.`,
    quiz: { q:"Fix this: ‚Äòwe visited zimbabwe in april.‚Äô", a:"We visited Zimbabwe in April." },
    visual: () => highlightCapsVisual("we visited zimbabwe in april.")
  }
};

function openTutor(){
  tutorPanel.classList.add("open");
}
function closeTutorPanel(){
  tutorPanel.classList.remove("open");
}

function setMode(mode){
  tutorMode = mode;
  modeOffline.classList.toggle("active", mode === "offline");
  modeAI.classList.toggle("active", mode === "ai");
  fabHint.textContent = mode === "offline" ? "(offline)" : "(AI)";
  if(mode === "ai"){
    botSay(`AI mode is ON ‚ú®\nNote: AI mode needs a secure backend endpoint so your API key stays private.`);
  }
}

function setCurrentTopic(item){
  currentTopic = item;
  tutorTopicEl.textContent = `Topic: ${item.topic}`;
}

function addMsg(role, text){
  const row = document.createElement("div");
  row.className = `msg ${role}`;
  const b = document.createElement("div");
  b.className = "bubble";
  b.textContent = text;
  row.appendChild(b);
  chatLog.appendChild(row);
  chatLog.scrollTop = chatLog.scrollHeight;
}
function botSay(text){ addMsg("bot", text); }
function userSay(text){ addMsg("user", text); }

function ensureTopicSelected(){
  if(currentTopic) return true;
  botSay("Pick a topic first üíñ Tap ‚Äòü©∑ Ask Tutor‚Äô on any topic card.");
  return false;
}

function getOfflinePack(topicName){
  if(OFFLINE_TUTOR[topicName]) return OFFLINE_TUTOR[topicName];
  const key = Object.keys(OFFLINE_TUTOR).find(k => topicName.toLowerCase().includes(k.toLowerCase().slice(0,10)));
  return key ? OFFLINE_TUTOR[key] : null;
}

function renderVisual(fn){
  const wrap = document.createElement("div");
  wrap.className = "miniVisual";
  wrap.innerHTML = fn();
  const row = document.createElement("div");
  row.className = "msg bot";
  const b = document.createElement("div");
  b.className = "bubble";
  b.textContent = "Here‚Äôs a visual:";
  row.appendChild(b);
  chatLog.appendChild(row);
  chatLog.appendChild(wrap);
  chatLog.scrollTop = chatLog.scrollHeight;
}

let tutorExpected = null;
let tutorExpectedType = null;

function handleOffline(message){
  if(!ensureTopicSelected()) return;
  const pack = getOfflinePack(currentTopic.topic);

  // If user is answering a quiz
  if(tutorExpectedType === "quiz" && tutorExpected){
    const ans = message.trim().toLowerCase();
    const exp = String(tutorExpected).trim().toLowerCase();
    if(ans === exp){
      botSay("‚úÖ YESSS! That‚Äôs correct! üåü\nWant another quiz or an example?");
    } else {
      botSay(`Almost! üíñ The answer is: ${tutorExpected}.\nWant me to explain why?`);
    }
    tutorExpected = null;
    tutorExpectedType = null;
    return;
  }

  if(!pack){
    botSay(`I can help with ‚Äú${currentTopic.topic}‚Äù üíñ\nTell me which bit feels confusing, and I‚Äôll explain step-by-step.`);
    if(/visual|draw|show/i.test(message)){
      renderVisual(() => simpleStepsVisual(["What is it?","How do we do it?","Try 1 example","Quick quiz"]));
    }
    return;
  }

  if(/quiz|question|test/i.test(message)){
    botSay(`Quick quiz ‚ú®\n${pack.quiz.q}`);
    botSay("Reply with your answer.");
    tutorExpected = pack.quiz.a;
    tutorExpectedType = "quiz";
    return;
  }
  if(/example|show me|like/i.test(message)){
    botSay(pack.example);
    return;
  }
  if(/visual|draw|picture|diagram/i.test(message)){
    renderVisual(pack.visual);
    return;
  }

  botSay(pack.explain);
}

// Optional AI mode (requires backend). Keep API key on the server.
async function handleAI(message){
  if(!ensureTopicSelected()) return;
  botSay("Thinking‚Ä¶ ‚ú®");
  try{
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        topic: currentTopic.topic,
        subject: activeTab,
        message,
        age: 10
      })
    });
    if(!res.ok) throw new Error("Bad response");
    const data = await res.json();
    botSay(data.reply || "Sorry, I didn‚Äôt get a reply.");
  }catch(e){
    botSay("AI mode isn‚Äôt connected yet.\nAdd a tiny backend endpoint at /api/chat to safely call the AI.");
  }
}

function sendChat(text){
  const msg = (text ?? chatInput.value).trim();
  if(!msg) return;
  userSay(msg);
  chatInput.value = "";
  if(tutorMode === "offline") handleOffline(msg);
  else handleAI(msg);
}

// Quick buttons
qExplain.addEventListener("click", () => sendChat("explain"));
qExample.addEventListener("click", () => sendChat("example"));
qQuiz.addEventListener("click", () => sendChat("quiz"));
qVisual.addEventListener("click", () => sendChat("show visual"));

sendBtn.addEventListener("click", () => sendChat());
chatInput.addEventListener("keydown", (e) => {
  if(e.key === "Enter") sendChat();
});

modeOffline.addEventListener("click", () => setMode("offline"));
modeAI.addEventListener("click", () => setMode("ai"));
closeTutor.addEventListener("click", closeTutorPanel);

tutorFab.addEventListener("click", () => {
  openTutor();
  if(!chatLog.childElementCount){
    botSay("Hi Micaela üíñ I‚Äôm your tutor!\nTap ‚Äòü©∑ Ask Tutor‚Äô on a topic to start, or ask me anything.");
  }
});

// === Simple visuals ===
function numberLineVisual(min, max, step){
  const ticks = [];
  for(let x=min; x<=max; x+=step){ ticks.push(x); }
  return `
  <div style="font-weight:950; margin-bottom:6px;">Number line jumps of ${step}</div>
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    ${ticks.map(t => `<span style="padding:6px 10px;border-radius:999px;border:1px solid rgba(26,18,48,.12);background:rgba(255,255,255,.9);font-weight:950;">${t}</span>`).join("")}
  </div>`;
}

function fractionBarVisual(n, d){
  const parts = Array.from({length:d}).map((_,i)=>{
    const filled = i < n;
    return `<div style="flex:1;height:18px;border-radius:8px;border:1px solid rgba(26,18,48,.12);background:${filled?"rgba(255,79,216,.28)":"rgba(255,255,255,.85)"};"></div>`;
  }).join("");
  return `
  <div style="font-weight:950; margin-bottom:6px;">Fraction bar: ${n}/${d}</div>
  <div style="display:flex; gap:6px;">${parts}</div>`;
}

function fractionCompareVisual(a,b,c,d){
  return `
  <div style="font-weight:950; margin-bottom:8px;">Compare fractions</div>
  <div style="display:grid; gap:10px;">
    <div><div style="font-weight:900;margin-bottom:4px;">${a}/${b}</div>${fractionBarVisual(a,b)}</div>
    <div><div style="font-weight:900;margin-bottom:4px;">${c}/${d}</div>${fractionBarVisual(c,d)}</div>
  </div>`;
}

function placeValueVisual(numStr){
  const labels = ["ones","tens","hundreds","thousands","ten-thousands","hundred-thousands","millions"];
  const digits = numStr.split("").reverse();
  const rows = digits.map((dig,i)=>{
    const val = Number(dig) * Math.pow(10,i);
    return `<div style="display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border-radius:14px;border:1px solid rgba(26,18,48,.10);background:rgba(255,255,255,.86);font-weight:900;">
      <span>${dig} in the <strong>${labels[i]||("10^"+i)}</strong> place</span>
      <span>value = <strong>${val.toLocaleString()}</strong></span>
    </div>`;
  }).reverse().join("");
  return `
  <div style="font-weight:950; margin-bottom:8px;">Place value for ${numStr}</div>
  <div style="display:grid; gap:8px;">${rows}</div>`;
}

function clueBubbleVisual(clues, inference){
  return `
  <div style="font-weight:950;margin-bottom:8px;">Clues ‚Üí Inference</div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    ${clues.map(c=>`<span style="padding:8px 10px;border-radius:999px;border:1px solid rgba(26,18,48,.12);background:rgba(255,255,255,.88);font-weight:950;">üß© ${c}</span>`).join("")}
    <span style="font-weight:950;">‚û°Ô∏è</span>
    <span style="padding:10px 12px;border-radius:999px;border:1px solid rgba(26,18,48,.12);background:rgba(255,79,216,.22);font-weight:950;">üí° ${inference}</span>
  </div>`;
}

function highlightCapsVisual(sentence){
  // IMPORTANT: use \b word boundaries (avoid invisible control chars)
  return `
  <div style="font-weight:950;margin-bottom:6px;">Capital letters fix</div>
  <div style="padding:10px 12px;border-radius:14px;border:1px solid rgba(26,18,48,.10);background:rgba(255,255,255,.88);font-weight:900;">
    ${sentence.replace(/\b(i|zimbabwe|april)\b/gi, (m)=>`<span style="background:rgba(0,229,255,.22);padding:0 4px;border-radius:8px;">${m}</span>`)}
  </div>
  <div style="margin-top:8px;font-weight:900;">Now rewrite it with capitals in the right places ‚ú®</div>`;
}

function simpleStepsVisual(steps){
  return `
  <div style="font-weight:950;margin-bottom:8px;">Let‚Äôs learn it step-by-step</div>
  <div style="display:grid; gap:8px;">
    ${steps.map((s,i)=>`<div style="padding:8px 10px;border-radius:14px;border:1px solid rgba(26,18,48,.10);background:rgba(255,255,255,.86);font-weight:900;">${i+1}. ${s}</div>`).join("")}
  </div>`;
}

// ====== Lightweight self-tests (run in console) ======
function runSelfTests(){
  try{
    console.assert(typeof numberLineVisual(0,14,7) === "string", "numberLineVisual should return a string");
    console.assert(typeof fractionBarVisual(1,2) === "string", "fractionBarVisual should return a string");
    console.assert(typeof highlightCapsVisual("we visited zimbabwe in april.") === "string", "highlightCapsVisual should return a string");
    console.assert(OFFLINE_TUTOR["Counting in multiples (input/output tables)"]?.quiz?.a === "16", "offline tutor sample quiz should exist");
    console.log("‚úÖ Self-tests passed");
  }catch(e){
    console.error("‚ùå Self-tests failed", e);
  }
}

// initial render
render();
runSelfTests();
</script>
</body>
</html>
